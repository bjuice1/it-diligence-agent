{% extends "base.html" %}
{% block title %}IT Staffing - Organization{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/organization.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/org_tree.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{{ url_for('organization_overview') }}" class="back-link">&larr; Back to Organization</a>
    <h1>IT Staffing by Function</h1>
    <p class="subtitle">Census data with role-level drill-down</p>
</div>

<div class="staffing-container">
    <!-- Summary Stats -->
    <div class="summary-stats">
        <div class="stat-card">
            <span class="stat-value">{{ total_headcount }}</span>
            <span class="stat-label">Total Headcount</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">${{ "{:,.0f}".format(total_compensation) }}</span>
            <span class="stat-label">Total Compensation</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ fte_count }}</span>
            <span class="stat-label">FTEs</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ contractor_count }}</span>
            <span class="stat-label">Contractors</span>
        </div>
        <div class="stat-card {{ 'highlight' if key_person_count > 0 else '' }}">
            <span class="stat-value">{{ key_person_count }}</span>
            <span class="stat-label">Key Persons</span>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="view-toggle">
        <button class="view-btn active" id="btn-tree-view" onclick="showView('tree')">
            <span>&#128101;</span> Census View
        </button>
        <button class="view-btn" id="btn-chart-view" onclick="showView('chart')">
            <span>&#128200;</span> Org Chart View
        </button>
    </div>

    <!-- Org Chart View (CSS Tree) -->
    <div id="chart-view" class="view-content" style="display: none;">
        {% if categories %}
        <div class="chart-controls">
            <label for="chart-level">Detail Level:</label>
            <select id="chart-level" onchange="updateChart()">
                <option value="1">Level 1 - Departments Only</option>
                <option value="2" selected>Level 2 - Show Roles</option>
                <option value="3">Level 3 - Individual Contributors</option>
            </select>
            <label for="dept-filter">Focus on Department:</label>
            <select id="dept-filter" onchange="updateChart()">
                <option value="all">All Departments</option>
                {% for cat_name in categories.keys() %}
                <option value="{{ cat_name }}">{{ categories[cat_name].display_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="org-tree-container" id="org-tree-container">
            <div class="org-tree" id="org-tree-root">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        {% else %}
        <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 64px; margin-bottom: 20px;">üè¢</div>
            <h3 style="margin: 0 0 12px 0; color: var(--text-primary);">No Org Chart Data</h3>
            <p style="margin: 0;">Run analysis on documents with staffing information to generate the org chart.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tree View (existing) -->
    <div id="tree-view" class="view-content">
    <!-- Controls -->
    <div class="tree-controls">
        <button class="btn btn-sm" onclick="expandAll()">Expand All</button>
        <button class="btn btn-sm" onclick="collapseAll()">Collapse All</button>
        <select id="entity-filter" onchange="filterByEntity(this.value)">
            <option value="all">All Entities</option>
            <option value="target" selected>Target Only</option>
            <option value="buyer">Buyer Only</option>
        </select>
        <label class="checkbox-label">
            <input type="checkbox" id="show-key-persons" onchange="toggleKeyPersonHighlight(this.checked)" checked>
            Highlight Key Persons
        </label>
    </div>

    <!-- Staffing Tree -->
    <div class="staffing-tree" id="staffing-tree">
        {% if not categories %}
        <div class="empty-state" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <h3 style="margin: 0 0 8px 0; color: var(--text-primary);">No Organization Data Available</h3>
            <p style="margin: 0 0 16px 0;">Organization staffing data has not been extracted yet.</p>
            <p style="margin: 0; font-size: 0.9em;">
                Run an analysis on documents containing IT staffing information to populate this view.
            </p>
            <a href="{{ url_for('organization_refresh') }}" class="btn btn-primary" style="margin-top: 20px; display: inline-block; padding: 10px 20px; background: var(--accent); color: white; border-radius: 6px; text-decoration: none;">
                ‚Üª Refresh Organization Data
            </a>
            {% if debug_info %}
            <div style="margin-top: 30px; padding: 15px; background: var(--bg-surface-sunken); border-radius: 8px; text-align: left; font-size: 0.85em;">
                <strong>Debug Info:</strong>
                <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                    <li>Data Source: {{ debug_info.data_source }}</li>
                    <li>Deal ID: {{ debug_info.deal_id }}</li>
                    <li>Total Facts: {{ debug_info.total_facts }}</li>
                    <li>Organization Facts: {{ debug_info.org_facts }}</li>
                    <li>Staff Members: {{ debug_info.staff_members }}</li>
                    {% if debug_info.org_categories %}
                    <li>Org Categories Found: {{ debug_info.org_categories }}</li>
                    {% endif %}
                    {% if debug_info.org_samples %}
                    <li>Sample Facts:
                        <ul style="margin-top: 4px;">
                        {% for sample in debug_info.org_samples %}
                            <li>{{ sample.item }} (cat: {{ sample.category }}, has_details: {{ sample.has_details }})</li>
                        {% endfor %}
                        </ul>
                    </li>
                    {% endif %}
                </ul>
                {% if debug_info.org_facts == 0 %}
                <p style="margin-top: 10px; color: var(--warning);">
                    <strong>Issue:</strong> No organization-domain facts found. Check if analysis has been run and includes organization discovery.
                </p>
                {% elif debug_info.staff_members == 0 %}
                <p style="margin-top: 10px; color: var(--warning);">
                    <strong>Issue:</strong> Organization facts exist ({{ debug_info.org_facts }}) but no staff members were created.
                    {% if debug_info.org_categories %}
                    <br>Categories found: {{ debug_info.org_categories.keys()|list }}
                    <br>Expected categories: leadership, central_it, roles, app_teams, outsourcing, embedded_it, key_individuals
                    {% endif %}
                </p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% for cat_name, category in categories.items() %}
        <div class="tree-category expanded" data-category="{{ cat_name }}">
            <div class="category-header" onclick="toggleCategory('{{ cat_name }}')">
                <span class="expand-icon">&#9654;</span>
                <span class="category-name">{{ category.display_name }}</span>
                <span class="category-count">({{ category.total_headcount }})</span>
                <span class="category-comp">${{ "{:,.0f}".format(category.total_compensation) }}</span>
            </div>
            <div class="category-content" id="content-{{ cat_name }}">
                {% for role in category.roles %}
                <div class="tree-role expanded" data-role="{{ role.role_title }}">
                    <div class="role-header" onclick="toggleRole('{{ cat_name }}', '{{ loop.index }}')">
                        <span class="expand-icon">&#9654;</span>
                        <span class="role-title">{{ role.role_title }}</span>
                        {% if role.headcount > 1 %}
                        <span class="role-count">({{ role.headcount }})</span>
                        {% endif %}
                        <span class="role-comp">${{ "{:,.0f}".format(role.avg_compensation) }} avg</span>
                    </div>
                    <div class="role-content" id="content-{{ cat_name }}-{{ loop.index }}">
                        {% for person in role.members %}
                        <div class="tree-person {% if person.is_key_person %}key-person{% endif %}"
                             data-entity="{{ person.entity }}">
                            <span class="person-name">
                                {% if person.name and person.name.startswith('Staff ') %}
                                    {# Generic staff - show role title with number #}
                                    <span class="person-role-title">{{ person.role_title }}</span>
                                    {% if role.headcount > 1 %}<span class="person-number">#{{ loop.index }}</span>{% endif %}
                                {% elif person.name == person.role_title or person.name in person.role_title or person.role_title in person.name %}
                                    {# Name matches role title - just show the name/role #}
                                    <span class="person-role-title">{{ person.name }}</span>
                                    {% if role.headcount > 1 and role.members|length > 1 %}<span class="person-number">#{{ loop.index }}</span>{% endif %}
                                {% else %}
                                    {# Real name with different role title #}
                                    {{ person.name }} <span class="person-role-inline">({{ person.role_title }})</span>
                                {% endif %}
                                {% if person.is_key_person %}
                                <span class="key-badge" title="{{ person.key_person_reason }}">&#9888;</span>
                                {% endif %}
                            </span>
                            <span class="person-comp">${{ "{:,.0f}".format(person.base_compensation) }}</span>
                            <span class="person-tenure">
                                {% if person.tenure_years %}{{ "%.1f"|format(person.tenure_years) }} yrs{% else %}-{% endif %}
                            </span>
                            <span class="person-type {{ person.employment_type.value }}">
                                {{ person.employment_type.value|upper }}
                            </span>
                            <span class="person-location">{{ person.location }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    </div><!-- end tree-view -->
</div>

<style>
.view-toggle {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    padding: 10px;
    background: var(--bg-surface-sunken);
    border-radius: 8px;
}
.view-btn {
    padding: 10px 20px;
    border: 1px solid var(--border-default);
    border-radius: 6px;
    background: var(--bg-surface);
    cursor: pointer;
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 8px;
}
.view-btn:hover {
    border-color: var(--accent);
}
.view-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}
.chart-controls {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}
.chart-controls select {
    padding: 8px 12px;
    border: 1px solid var(--border-default);
    border-radius: 6px;
    background: var(--bg-surface);
}
/* Org tree container overrides */
/* Person display enhancements */
.person-role-title {
    font-weight: 500;
    color: var(--text-primary);
}
.person-role-inline {
    color: var(--text-muted);
    font-weight: normal;
    font-size: 0.9em;
}
.person-number {
    color: var(--text-muted);
    font-size: 0.85em;
    margin-left: 4px;
    opacity: 0.7;
}
/* Chart level selector */
.chart-controls select {
    min-width: 180px;
}
</style>

<script src="{{ url_for('static', filename='js/staffing_tree.js') }}"></script>
<script>
// Org chart data from server (includes member details for Level 3)
const orgData = {
    {% for cat_name, category in categories.items() %}
    "{{ cat_name }}": {
        "display_name": "{{ category.display_name }}",
        "total": {{ category.total_headcount }},
        "roles": [
            {% for role in category.roles %}
            {
                "title": "{{ role.role_title|e }}",
                "headcount": {{ role.headcount }},
                "members": [
                    {% for member in role.members %}
                    {
                        "name": "{{ member.name|e }}",
                        "role_title": "{{ member.role_title|e }}",
                        "employment_type": "{{ member.employment_type.value }}",
                        "compensation": {{ member.base_compensation|default(0) }}
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

// MSP/Vendor data from server
const mspData = [
    {% if msp_relationships %}
    {% for msp in msp_relationships %}
    {
        "name": "{{ msp.vendor_name|e }}",
        "fte_equivalent": {{ msp.total_fte_equivalent|default(0) }},
        "services": [{% for svc in msp.services %}"{{ svc.service_name|e }}"{% if not loop.last %},{% endif %}{% endfor %}],
        "scope": "{{ msp.services[0].scope_description|e if msp.services else '' }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
    {% endif %}
];

function showView(view) {
    const treeView = document.getElementById('tree-view');
    const chartView = document.getElementById('chart-view');
    const btnTree = document.getElementById('btn-tree-view');
    const btnChart = document.getElementById('btn-chart-view');

    if (view === 'tree') {
        treeView.style.display = 'block';
        chartView.style.display = 'none';
        btnTree.classList.add('active');
        btnChart.classList.remove('active');
    } else {
        treeView.style.display = 'none';
        chartView.style.display = 'block';
        btnTree.classList.remove('active');
        btnChart.classList.add('active');
        updateChart();
    }
}

// =========================================================================
// CSS Tree Builder ‚Äî replaces Mermaid
// =========================================================================

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function createNode(type, title, subtitle, badge) {
    const node = document.createElement('div');
    node.className = `org-node ${type}`;

    let html = `<span class="node-title">${escapeHtml(title)}</span>`;
    if (subtitle) html += `<span class="node-subtitle">${escapeHtml(subtitle)}</span>`;
    if (badge) html += `<span class="node-badge">${escapeHtml(badge)}</span>`;
    node.innerHTML = html;
    return node;
}

function createBranch(nodeEl, children) {
    const branch = document.createElement('div');
    branch.className = 'org-tree-branch';
    branch.appendChild(nodeEl);

    if (children && children.length > 0) {
        nodeEl.classList.add('collapsible');
        nodeEl.addEventListener('click', function(e) {
            e.stopPropagation();
            branch.classList.toggle('collapsed');
        });

        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'org-tree-children';
        children.forEach(child => childrenContainer.appendChild(child));

        // Set CSS variable for horizontal connector width
        setTimeout(() => {
            if (children.length > 1) {
                const firstRect = children[0].getBoundingClientRect();
                const lastRect = children[children.length - 1].getBoundingClientRect();
                const totalWidth = lastRect.left + lastRect.width / 2 - firstRect.left - firstRect.width / 2;
                childrenContainer.style.setProperty('--half-width', Math.abs(totalWidth / 2) + 'px');
            }
        }, 50);

        branch.appendChild(childrenContainer);
    }

    return branch;
}

function updateChart() {
    const filter = document.getElementById('dept-filter').value;
    const level = document.getElementById('chart-level').value;
    const root = document.getElementById('org-tree-root');

    root.innerHTML = '';

    // Build department branches
    const deptBranches = [];

    for (const [catName, catData] of Object.entries(orgData)) {
        if (filter !== 'all' && catName !== filter) continue;

        const deptNode = createNode('department', catData.display_name, `${catData.total} FTE`, null);

        let roleBranches = [];

        if (level === '2' || level === '3') {
            const maxRoles = (level === '3' && filter === 'all') ? 4 : 8;
            const visibleRoles = catData.roles.slice(0, maxRoles);

            roleBranches = visibleRoles.map(role => {
                const hcText = role.headcount > 1 ? `(${role.headcount})` : '';
                const roleNode = createNode('role', role.title, null, hcText || null);

                let memberBranches = [];

                if (level === '3') {
                    const maxMembers = 5;
                    const visibleMembers = role.members.slice(0, maxMembers);

                    memberBranches = visibleMembers.map(member => {
                        let memberLabel;
                        if (member.name && !member.name.startsWith('Staff ')) {
                            memberLabel = member.name;
                        } else {
                            memberLabel = role.title;
                        }
                        const typeIcon = member.employment_type === 'contractor' ? 'üìù' : 'üë§';
                        const compText = member.compensation > 0
                            ? `$${(member.compensation/1000).toFixed(0)}k`
                            : null;
                        const memberNode = createNode('member',
                            `${typeIcon} ${memberLabel}`, compText, member.employment_type.toUpperCase()
                        );
                        return createBranch(memberNode, null);
                    });

                    if (role.members.length > maxMembers) {
                        const moreNode = createNode('more',
                            `+${role.members.length - maxMembers} more`, null, null
                        );
                        memberBranches.push(createBranch(moreNode, null));
                    }
                }

                return createBranch(roleNode, memberBranches.length > 0 ? memberBranches : null);
            });

            if (catData.roles.length > maxRoles) {
                const moreNode = createNode('more',
                    `+${catData.roles.length - maxRoles} more roles`, null, null
                );
                roleBranches.push(createBranch(moreNode, null));
            }
        }

        deptBranches.push(createBranch(deptNode, roleBranches.length > 0 ? roleBranches : null));
    }

    // Build full tree: CEO -> Departments
    const ceoNode = createNode('leadership', 'CIO / IT Leader', null, null);
    const tree = createBranch(ceoNode, deptBranches);
    root.appendChild(tree);

    // Add vendors section below the tree
    if (mspData.length > 0) {
        const vendorsSection = document.createElement('div');
        vendorsSection.className = 'org-vendors-section';
        vendorsSection.innerHTML = '<div class="org-vendors-label">External Vendor Support</div>';

        mspData.forEach(msp => {
            const svcText = msp.services.length > 0
                ? msp.services.slice(0, 2).join(', ')
                : msp.scope;
            const vendorNode = createNode('vendor', msp.name,
                `${msp.fte_equivalent} FTE eq.`, svcText || null
            );
            vendorsSection.appendChild(vendorNode);
        });

        root.appendChild(vendorsSection);
    }

    // Recalculate connector widths after DOM renders
    requestAnimationFrame(() => {
        root.querySelectorAll('.org-tree-children').forEach(container => {
            const branches = Array.from(container.children);
            if (branches.length > 1) {
                const firstNode = branches[0].querySelector('.org-node');
                const lastNode = branches[branches.length - 1].querySelector('.org-node');
                if (firstNode && lastNode) {
                    const firstRect = firstNode.getBoundingClientRect();
                    const lastRect = lastNode.getBoundingClientRect();
                    const halfWidth = Math.abs(lastRect.left + lastRect.width / 2 - firstRect.left - firstRect.width / 2) / 2;
                    container.style.setProperty('--half-width', halfWidth + 'px');
                }
            }
        });
    });
}
</script>
{% endblock %}
