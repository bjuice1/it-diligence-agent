{% extends "base.html" %}
{% block title %}Organization Analysis{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/organization.css') }}">
{% endblock %}

{% block content %}
<!-- Data Source Indicator -->
{% if data_source == 'no_data' or data_source == 'demo' %}
<div class="data-source-banner data-source-demo">
    <span class="banner-icon">&#128269;</span>
    <span class="banner-text"><strong>No Data Yet</strong> - Upload documents and run an analysis to see organization data.</span>
    <a href="{{ url_for('upload_documents') }}" class="btn btn-sm">Upload Documents</a>
</div>
{% elif data_source == 'analysis_no_org' %}
<div class="data-source-banner data-source-warning">
    <span class="banner-icon">&#128269;</span>
    <span class="banner-text"><strong>No Organization Data</strong> - Analysis completed but no organization/staffing information was found in your documents.</span>
    <a href="{{ url_for('upload_documents') }}" class="btn btn-sm">Upload More Documents</a>
</div>
{% elif data_source == 'analysis' %}
<div class="data-source-banner data-source-analysis">
    <span class="banner-icon">&#10003;</span>
    <span class="banner-text"><strong>Analysis Data</strong> - Showing organization data extracted from your documents.</span>
</div>
{% endif %}

<div class="page-header">
    <div class="header-with-actions">
        <div>
            <h1>Organization & Staffing Analysis</h1>
            <p class="subtitle">IT staffing assessment with benchmark comparison and dependency analysis</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('organization_refresh') }}" class="btn btn-secondary">&#8635; Refresh from Analysis</a>
        </div>
    </div>
</div>

<!-- View Toggle and Entity Filter -->
<div class="controls-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
    <div class="view-toggle-container">
        <div class="tabs" style="max-width: 300px;">
            <button class="tab active" data-view="inventory">Inventory</button>
            <button class="tab" data-view="report">Report</button>
        </div>
    </div>

    <!-- Entity Filter -->
    <div class="entity-filter" id="entity-filter">
        <span class="filter-label">Show:</span>
        <button class="entity-btn active" data-entity="all">All</button>
        <button class="entity-btn entity-target" data-entity="target">
            <span class="entity-icon">üéØ</span> TARGET
        </button>
        <button class="entity-btn entity-buyer" data-entity="buyer">
            <span class="entity-icon">üè¢</span> BUYER
        </button>
    </div>
</div>

<!-- Inventory View -->
<div id="inventory-view">

<div class="org-overview">
    <!-- Quick Stats Row -->
    <div class="summary-stats">
        <div class="stat-card">
            <span class="stat-value">{{ store.get_target_headcount() }}</span>
            <span class="stat-label">Total IT Staff</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">${{ "{:,.0f}".format(store.total_compensation) }}</span>
            <span class="stat-label">Total Comp</span>
        </div>
        <div class="stat-card {{ 'highlight' if store.get_key_persons()|length > 0 else '' }}">
            <span class="stat-value">{{ store.get_key_persons()|length }}</span>
            <span class="stat-label">Key Persons</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ msp_summary.total_msp_count }}</span>
            <span class="stat-label">MSP Vendors</span>
        </div>
        <div class="stat-card {{ 'highlight' if ss_summary.hidden_headcount_need > 0 else '' }}">
            <span class="stat-value">{{ "%.1f"|format(ss_summary.hidden_headcount_need) }}</span>
            <span class="stat-label">Hidden FTE</span>
        </div>
    </div>

    <!-- Navigation Cards -->
    <div class="nav-cards">
        <a href="{{ url_for('organization_staffing') }}" class="nav-card">
            <div class="nav-card-icon">&#128101;</div>
            <div class="nav-card-content">
                <h3>Staffing Census</h3>
                <p>Role-by-role breakdown with compensation and tenure data</p>
                <span class="nav-card-stat">{{ store.get_target_headcount() }} staff | {{ store.total_internal_fte }} FTE, {{ store.total_contractor }} contractors</span>
            </div>
        </a>

        <a href="{{ url_for('organization_benchmark') }}" class="nav-card">
            <div class="nav-card-icon">&#128202;</div>
            <div class="nav-card-content">
                <h3>Benchmark Comparison</h3>
                <p>Compare staffing against industry benchmarks</p>
                <span class="nav-card-stat status-{{ comparison.overall_status }}">
                    Status: {{ comparison.overall_status|title }}
                </span>
            </div>
        </a>

        <a href="{{ url_for('organization_msp') }}" class="nav-card">
            <div class="nav-card-icon">&#128279;</div>
            <div class="nav-card-content">
                <h3>MSP Dependencies</h3>
                <p>Outsourced services, FTE equivalents, and exit risk</p>
                <span class="nav-card-stat">{{ msp_summary.total_msp_count }} vendors | {{ "%.1f"|format(msp_summary.total_fte_equivalent) }} FTE eq.</span>
            </div>
        </a>

        <a href="{{ url_for('organization_shared_services') }}" class="nav-card">
            <div class="nav-card-icon">&#127970;</div>
            <div class="nav-card-content">
                <h3>Shared Services</h3>
                <p>Hidden headcount from parent company dependencies</p>
                <span class="nav-card-stat {{ 'highlight' if ss_summary.non_transferring_fte > 0 else '' }}">
                    {{ "%.1f"|format(ss_summary.non_transferring_fte) }} not transferring FTE | {{ "%.1f"|format(ss_summary.hidden_headcount_need) }} hidden FTE need
                </span>
            </div>
        </a>
    </div>

    <!-- IT Support Coverage by Function -->
    <div class="activity-diagram">
        <h3>How IT Supports the Business</h3>
        <p class="diagram-subtitle">What each team owns and maintains</p>
        <div class="activity-grid">
            <div class="activity-card applications">
                <div class="activity-icon">&#128187;</div>
                <div class="activity-name">Applications Team</div>
                <div class="activity-support">
                    <strong>Supports:</strong>
                    <ul class="activity-tasks">
                        <li>ERP System (primary business system)</li>
                        <li>CRM & Sales tools</li>
                        <li>Custom/internal applications</li>
                        <li>Integrations & data flows</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> Vendor support contracts, MSP for after-hours
                </div>
            </div>
            <div class="activity-card infrastructure">
                <div class="activity-icon">&#127760;</div>
                <div class="activity-name">Infrastructure Team</div>
                <div class="activity-support">
                    <strong>Maintains:</strong>
                    <ul class="activity-tasks">
                        <li>Cloud environment (AWS/Azure)</li>
                        <li>Active Directory & identity</li>
                        <li>On-prem servers & storage</li>
                        <li>Backup & disaster recovery</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> Cloud MSP, hardware vendor support
                </div>
            </div>
            <div class="activity-card cybersecurity">
                <div class="activity-icon">&#128274;</div>
                <div class="activity-name">Security Team</div>
                <div class="activity-support">
                    <strong>Manages:</strong>
                    <ul class="activity-tasks">
                        <li>Endpoint protection & EDR</li>
                        <li>Firewall & perimeter security</li>
                        <li>Vulnerability management</li>
                        <li>Security monitoring (SIEM)</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> MSSP for 24/7 SOC, pen testing
                </div>
            </div>
            <div class="activity-card network">
                <div class="activity-icon">&#128225;</div>
                <div class="activity-name">Network Team</div>
                <div class="activity-support">
                    <strong>Operates:</strong>
                    <ul class="activity-tasks">
                        <li>WAN connectivity & MPLS</li>
                        <li>LAN switching & WiFi</li>
                        <li>VPN & remote access</li>
                        <li>DNS & DHCP services</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> ISP, telecom carriers
                </div>
            </div>
            <div class="activity-card identity">
                <div class="activity-icon">&#128100;</div>
                <div class="activity-name">Identity & Access</div>
                <div class="activity-support">
                    <strong>Controls:</strong>
                    <ul class="activity-tasks">
                        <li>User provisioning/deprovisioning</li>
                        <li>SSO & MFA systems</li>
                        <li>Privileged access (PAM)</li>
                        <li>Access reviews & governance</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> Identity SaaS vendor
                </div>
            </div>
            <div class="activity-card organization active">
                <div class="activity-icon">&#128101;</div>
                <div class="activity-name">IT Organization</div>
                <div class="activity-support">
                    <strong>Current State:</strong>
                    <ul class="activity-tasks">
                        <li>{{ store.get_target_headcount() }} total IT staff</li>
                        <li>{{ store.total_internal_fte }} FTEs, {{ store.total_contractor }} contractors</li>
                        <li>{{ msp_summary.total_msp_count }} MSP vendors ({{ "%.1f"|format(msp_summary.total_fte_equivalent) }} FTE eq.)</li>
                        <li>{{ "%.1f"|format(ss_summary.hidden_headcount_need) }} hidden FTE from shared services</li>
                    </ul>
                </div>
                <div class="activity-badge">Current View</div>
            </div>
        </div>
    </div>

    <!-- Key Findings Summary -->
    {% if comparison.key_findings %}
    <div class="findings-section">
        <h3>Key Findings</h3>
        <ul class="findings-list">
            {% for finding in comparison.key_findings %}
            <li>{{ finding }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

</div>

</div><!-- End inventory-view -->

<!-- Report View -->
<div id="report-view" style="display: none;">
    <div class="report-container">
        <div class="report-content">
            <div class="report-loading">
                <div class="loading-spinner"></div>
                <p>Generating report narrative...</p>
            </div>
        </div>
        <div class="report-actions" style="display: none;">
            <button class="btn btn-secondary" onclick="regenerateNarrative()">Regenerate Narrative</button>
            <button class="btn btn-outline" onclick="copyNarrative()">Copy to Clipboard</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// View Toggle Functionality
let narrativeLoaded = false;
const domain = 'organization';

// Entity Filter Functionality
let currentEntityFilter = 'all';

document.querySelectorAll('.entity-filter .entity-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const entity = this.dataset.entity;
        currentEntityFilter = entity;

        // Update active button
        document.querySelectorAll('.entity-filter .entity-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // Filter table rows (if any tables exist on this page)
        filterByEntity(entity);
    });
});

function filterByEntity(entity) {
    const rows = document.querySelectorAll('table.table tbody tr');

    rows.forEach(row => {
        const rowEntity = row.dataset.entity || 'target';

        if (entity === 'all' || rowEntity === entity) {
            row.classList.remove('entity-hidden');
        } else {
            row.classList.add('entity-hidden');
        }
    });
}

document.querySelectorAll('.view-toggle-container .tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const view = this.dataset.view;

        // Update active tab
        document.querySelectorAll('.view-toggle-container .tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // Toggle views
        document.getElementById('inventory-view').style.display = view === 'inventory' ? 'block' : 'none';
        document.getElementById('report-view').style.display = view === 'report' ? 'block' : 'none';

        // Load narrative if switching to report view and not already loaded
        if (view === 'report' && !narrativeLoaded) {
            loadNarrative();
        }
    });
});

async function loadNarrative() {
    const container = document.querySelector('.report-content');
    const actions = document.querySelector('.report-actions');

    container.innerHTML = `
        <div class="report-loading">
            <div class="loading-spinner"></div>
            <p>Generating report narrative...</p>
        </div>
    `;
    actions.style.display = 'none';

    try {
        const response = await fetch(`/api/narrative/${domain}`);
        const data = await response.json();

        if (data.status === 'success') {
            renderNarrative(data);
            narrativeLoaded = true;
            actions.style.display = 'flex';
        } else if (data.status === 'placeholder') {
            renderPlaceholder(data);
        } else {
            container.innerHTML = `
                <div class="report-error">
                    <p><strong>Error generating narrative:</strong></p>
                    <p>${data.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="report-error">
                <p><strong>Failed to load narrative:</strong></p>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function renderNarrative(narrative) {
    const container = document.querySelector('.report-content');
    container.innerHTML = `
        <div class="report-section">
            <h3>Key Takeaway</h3>
            <p class="report-so-what report-editable" contenteditable="true">${narrative.so_what || 'No summary available'}</p>
        </div>

        ${narrative.considerations && narrative.considerations.length > 0 ? `
        <div class="report-section">
            <h3>Key Considerations</h3>
            <ul class="report-considerations">
                ${narrative.considerations.map(c => `<li class="report-editable" contenteditable="true">${c}</li>`).join('')}
            </ul>
        </div>
        ` : ''}

        <div class="report-section">
            <h3>Narrative</h3>
            <div class="report-narrative report-editable" contenteditable="true">${narrative.narrative || 'No detailed narrative available'}</div>
        </div>

        ${narrative.cost_summary ? `
        <div class="report-section">
            <h3>Cost Summary</h3>
            <div class="report-cost-summary report-editable" contenteditable="true">${narrative.cost_summary}</div>
        </div>
        ` : ''}

        ${narrative.key_facts && narrative.key_facts.length > 0 ? `
        <div class="report-section">
            <h3>Supporting Facts</h3>
            <ul class="report-key-facts">
                ${narrative.key_facts.map(f => `<li>${f}</li>`).join('')}
            </ul>
        </div>
        ` : ''}

        <div class="report-meta">
            <span class="confidence-badge confidence-${narrative.confidence === 'high' ? 'high' : narrative.confidence === 'medium' ? 'medium' : 'low'}">
                Confidence: ${narrative.confidence || 'medium'}
            </span>
        </div>
    `;
}

function renderPlaceholder(data) {
    const container = document.querySelector('.report-content');
    container.innerHTML = `
        <div class="report-placeholder">
            <h3>${data.so_what}</h3>
            <ul>
                ${data.considerations.map(c => `<li>${c}</li>`).join('')}
            </ul>
            <p class="text-muted">${data.narrative}</p>
        </div>
    `;
}

async function regenerateNarrative() {
    narrativeLoaded = false;
    const container = document.querySelector('.report-content');
    const actions = document.querySelector('.report-actions');

    container.innerHTML = `
        <div class="report-loading">
            <div class="loading-spinner"></div>
            <p>Regenerating narrative...</p>
        </div>
    `;
    actions.style.display = 'none';

    try {
        const response = await fetch(`/api/narrative/${domain}/regenerate`, { method: 'POST' });
        const data = await response.json();

        if (data.status === 'success') {
            renderNarrative(data);
            narrativeLoaded = true;
            actions.style.display = 'flex';
        } else {
            container.innerHTML = `
                <div class="report-error">
                    <p><strong>Error regenerating narrative:</strong></p>
                    <p>${data.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="report-error">
                <p><strong>Failed to regenerate narrative:</strong></p>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function copyNarrative() {
    const soWhat = document.querySelector('.report-so-what')?.innerText || '';
    const narrative = document.querySelector('.report-narrative')?.innerText || '';
    const considerations = Array.from(document.querySelectorAll('.report-considerations li'))
        .map(li => '- ' + li.innerText).join('\n');

    const fullText = `KEY TAKEAWAY:\n${soWhat}\n\nKEY CONSIDERATIONS:\n${considerations}\n\nNARRATIVE:\n${narrative}`;

    navigator.clipboard.writeText(fullText).then(() => {
        alert('Narrative copied to clipboard!');
    }).catch(err => {
        alert('Failed to copy: ' + err.message);
    });
}
</script>
{% endblock %}
