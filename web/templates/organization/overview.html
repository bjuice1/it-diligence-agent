{% extends "base.html" %}
{% block title %}Organization Analysis{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/organization.css') }}">
{% endblock %}

{% block content %}
<!-- Data Source Indicator -->
{% if data_source == 'demo' %}
<div class="data-source-banner data-source-demo">
    <span class="banner-icon">&#9888;</span>
    <span class="banner-text"><strong>Demo Data</strong> - No analysis data found. Run an analysis to see real organization data.</span>
    <a href="{{ url_for('upload') }}" class="btn btn-sm">Upload Documents</a>
</div>
{% elif data_source == 'analysis_no_org' %}
<div class="data-source-banner data-source-warning">
    <span class="banner-icon">&#128269;</span>
    <span class="banner-text"><strong>No Organization Data</strong> - Analysis completed but no organization/staffing information was found in your documents.</span>
    <a href="{{ url_for('upload') }}" class="btn btn-sm">Upload More Documents</a>
</div>
{% elif data_source == 'analysis' %}
<div class="data-source-banner data-source-analysis">
    <span class="banner-icon">&#10003;</span>
    <span class="banner-text"><strong>Analysis Data</strong> - Showing organization data extracted from your documents.</span>
</div>
{% endif %}

<div class="page-header">
    <div class="header-with-actions">
        <div>
            <h1>Organization & Staffing Analysis</h1>
            <p class="subtitle">IT staffing assessment with benchmark comparison and dependency analysis</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('organization_refresh') }}" class="btn btn-secondary">&#8635; Refresh from Analysis</a>
        </div>
    </div>
</div>

<div class="org-overview">
    <!-- Quick Stats Row -->
    <div class="summary-stats">
        <div class="stat-card">
            <span class="stat-value">{{ store.get_target_headcount() }}</span>
            <span class="stat-label">Total IT Staff</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">${{ "{:,.0f}".format(store.total_compensation) }}</span>
            <span class="stat-label">Total Comp</span>
        </div>
        <div class="stat-card {{ 'highlight' if store.get_key_persons()|length > 0 else '' }}">
            <span class="stat-value">{{ store.get_key_persons()|length }}</span>
            <span class="stat-label">Key Persons</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ msp_summary.total_msp_count }}</span>
            <span class="stat-label">MSP Vendors</span>
        </div>
        <div class="stat-card {{ 'highlight' if ss_summary.hidden_headcount_need > 0 else '' }}">
            <span class="stat-value">{{ "%.1f"|format(ss_summary.hidden_headcount_need) }}</span>
            <span class="stat-label">Hidden FTE</span>
        </div>
    </div>

    <!-- Navigation Cards -->
    <div class="nav-cards">
        <a href="{{ url_for('organization_staffing') }}" class="nav-card">
            <div class="nav-card-icon">&#128101;</div>
            <div class="nav-card-content">
                <h3>Staffing Census</h3>
                <p>Role-by-role breakdown with compensation and tenure data</p>
                <span class="nav-card-stat">{{ store.get_target_headcount() }} staff | {{ store.total_internal_fte }} FTE, {{ store.total_contractor }} contractors</span>
            </div>
        </a>

        <a href="{{ url_for('organization_benchmark') }}" class="nav-card">
            <div class="nav-card-icon">&#128202;</div>
            <div class="nav-card-content">
                <h3>Benchmark Comparison</h3>
                <p>Compare staffing against industry benchmarks</p>
                <span class="nav-card-stat status-{{ comparison.overall_status }}">
                    Status: {{ comparison.overall_status|title }}
                </span>
            </div>
        </a>

        <a href="{{ url_for('organization_msp') }}" class="nav-card">
            <div class="nav-card-icon">&#128279;</div>
            <div class="nav-card-content">
                <h3>MSP Dependencies</h3>
                <p>Outsourced services, FTE equivalents, and exit risk</p>
                <span class="nav-card-stat">{{ msp_summary.total_msp_count }} vendors | {{ "%.1f"|format(msp_summary.total_fte_equivalent) }} FTE eq.</span>
            </div>
        </a>

        <a href="{{ url_for('organization_shared_services') }}" class="nav-card">
            <div class="nav-card-icon">&#127970;</div>
            <div class="nav-card-content">
                <h3>Shared Services</h3>
                <p>Hidden headcount from parent company dependencies</p>
                <span class="nav-card-stat {{ 'highlight' if ss_summary.non_transferring_fte > 0 else '' }}">
                    {{ "%.1f"|format(ss_summary.non_transferring_fte) }} not transferring FTE | {{ "%.1f"|format(ss_summary.hidden_headcount_need) }} hidden FTE need
                </span>
            </div>
        </a>
    </div>

    <!-- IT Support Coverage by Function -->
    <div class="activity-diagram">
        <h3>How IT Supports the Business</h3>
        <p class="diagram-subtitle">What each team owns and maintains</p>
        <div class="activity-grid">
            <div class="activity-card applications">
                <div class="activity-icon">&#128187;</div>
                <div class="activity-name">Applications Team</div>
                <div class="activity-support">
                    <strong>Supports:</strong>
                    <ul class="activity-tasks">
                        <li>ERP System (primary business system)</li>
                        <li>CRM & Sales tools</li>
                        <li>Custom/internal applications</li>
                        <li>Integrations & data flows</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> Vendor support contracts, MSP for after-hours
                </div>
            </div>
            <div class="activity-card infrastructure">
                <div class="activity-icon">&#127760;</div>
                <div class="activity-name">Infrastructure Team</div>
                <div class="activity-support">
                    <strong>Maintains:</strong>
                    <ul class="activity-tasks">
                        <li>Cloud environment (AWS/Azure)</li>
                        <li>Active Directory & identity</li>
                        <li>On-prem servers & storage</li>
                        <li>Backup & disaster recovery</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> Cloud MSP, hardware vendor support
                </div>
            </div>
            <div class="activity-card cybersecurity">
                <div class="activity-icon">&#128274;</div>
                <div class="activity-name">Security Team</div>
                <div class="activity-support">
                    <strong>Manages:</strong>
                    <ul class="activity-tasks">
                        <li>Endpoint protection & EDR</li>
                        <li>Firewall & perimeter security</li>
                        <li>Vulnerability management</li>
                        <li>Security monitoring (SIEM)</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> MSSP for 24/7 SOC, pen testing
                </div>
            </div>
            <div class="activity-card network">
                <div class="activity-icon">&#128225;</div>
                <div class="activity-name">Network Team</div>
                <div class="activity-support">
                    <strong>Operates:</strong>
                    <ul class="activity-tasks">
                        <li>WAN connectivity & MPLS</li>
                        <li>LAN switching & WiFi</li>
                        <li>VPN & remote access</li>
                        <li>DNS & DHCP services</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> ISP, telecom carriers
                </div>
            </div>
            <div class="activity-card identity">
                <div class="activity-icon">&#128100;</div>
                <div class="activity-name">Identity & Access</div>
                <div class="activity-support">
                    <strong>Controls:</strong>
                    <ul class="activity-tasks">
                        <li>User provisioning/deprovisioning</li>
                        <li>SSO & MFA systems</li>
                        <li>Privileged access (PAM)</li>
                        <li>Access reviews & governance</li>
                    </ul>
                </div>
                <div class="activity-external">
                    <strong>External Support:</strong> Identity SaaS vendor
                </div>
            </div>
            <div class="activity-card organization active">
                <div class="activity-icon">&#128101;</div>
                <div class="activity-name">IT Organization</div>
                <div class="activity-support">
                    <strong>Current State:</strong>
                    <ul class="activity-tasks">
                        <li>{{ store.get_target_headcount() }} total IT staff</li>
                        <li>{{ store.total_internal_fte }} FTEs, {{ store.total_contractor }} contractors</li>
                        <li>{{ msp_summary.total_msp_count }} MSP vendors ({{ "%.1f"|format(msp_summary.total_fte_equivalent) }} FTE eq.)</li>
                        <li>{{ "%.1f"|format(ss_summary.hidden_headcount_need) }} hidden FTE from shared services</li>
                    </ul>
                </div>
                <div class="activity-badge">Current View</div>
            </div>
        </div>
    </div>

    <!-- Key Findings Summary -->
    {% if comparison.key_findings %}
    <div class="findings-section">
        <h3>Key Findings</h3>
        <ul class="findings-list">
            {% for finding in comparison.key_findings %}
            <li>{{ finding }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

</div>
{% endblock %}
