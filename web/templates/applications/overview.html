{% extends "base.html" %}
{% block title %}Applications Inventory{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Applications Inventory</h1>
    <p class="subtitle">{{ inventory.total_count }} applications identified across {{ inventory.by_category|length }} categories</p>
</div>

{% if data_source == 'none' or status != 'success' %}
<div class="data-source-banner data-source-demo">
    <strong>No Data</strong> - Run an analysis with documents containing application information to populate this inventory.
</div>
{% else %}
<div class="data-source-banner data-source-analysis">
    <strong>Analysis Data</strong> - Showing applications extracted from your documents.
</div>
{% endif %}

<!-- View Toggle and Entity Filter -->
<div class="controls-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
    <div class="view-toggle-container">
        <div class="tabs" style="max-width: 300px;">
            <button class="tab active" data-view="inventory">Inventory</button>
            <button class="tab" data-view="report">Report</button>
        </div>
    </div>

    <!-- Entity Filter -->
    <div class="entity-filter" id="entity-filter">
        <span class="filter-label">Show:</span>
        <button class="entity-btn active" data-entity="all">All</button>
        <button class="entity-btn entity-target" data-entity="target">
            <span class="entity-icon">üéØ</span> TARGET
        </button>
        <button class="entity-btn entity-buyer" data-entity="buyer">
            <span class="entity-icon">üè¢</span> BUYER
        </button>
    </div>
</div>

<!-- Inventory View -->
<div id="inventory-view">

<!-- Summary Stats -->
<div class="summary-stats" style="margin-bottom: 30px;">
    <div class="stat-card">
        <span class="stat-value">{{ inventory.total_count }}</span>
        <span class="stat-label">Total Applications</span>
    </div>
    <div class="stat-card {{ 'highlight' if inventory.critical_count > 0 else '' }}">
        <span class="stat-value">{{ inventory.critical_count }}</span>
        <span class="stat-label">Critical</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ inventory.saas_count }}</span>
        <span class="stat-label">SaaS</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ inventory.on_prem_count }}</span>
        <span class="stat-label">On-Premise</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ "{:,.0f}".format(inventory.total_users) }}</span>
        <span class="stat-label">Total Users</span>
    </div>
</div>

<!-- Categories Grid -->
<div class="categories-grid">
    {% for cat_name, cat_summary in inventory.by_category.items() %}
    <a href="{{ url_for('applications_category', category=cat_name) }}" class="category-card">
        <div class="category-icon">{{ cat_summary.category.icon }}</div>
        <div class="category-info">
            <h3>{{ cat_summary.category.display_name }}</h3>
            <div class="category-stats">
                <span class="category-count">{{ cat_summary.total_count }} apps</span>
                {% if cat_summary.critical_count > 0 %}
                <span class="badge badge-critical">{{ cat_summary.critical_count }} critical</span>
                {% endif %}
            </div>
            {% if cat_summary.total_users > 0 %}
            <div class="category-users">{{ "{:,.0f}".format(cat_summary.total_users) }} users</div>
            {% endif %}
        </div>
        <div class="category-arrow">&rarr;</div>
    </a>
    {% else %}
    <div class="empty-state">
        <p>No applications found in the analysis.</p>
        <p>Upload documents containing application information to see the inventory.</p>
    </div>
    {% endfor %}
</div>

<!-- Full Application List -->
{% if inventory.applications %}
<h2 style="margin-top: 40px; margin-bottom: 20px;">All Applications</h2>
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Application</th>
                <th>Category</th>
                <th>Vendor</th>
                <th>Deployment</th>
                <th>Users</th>
                <th>Criticality</th>
                <th>Source</th>
                <th>Confidence</th>
            </tr>
        </thead>
        <tbody>
            {% for app in inventory.applications %}
            <tr data-id="{{ app.id }}"
                data-name="{{ app.name|e }}"
                data-category="{{ app.category.value }}"
                data-vendor="{{ app.vendor|e }}"
                data-version="{{ app.version|e }}"
                data-deployment="{{ app.deployment.value }}"
                data-users="{{ app.user_count }}"
                data-criticality="{{ app.criticality.value }}"
                data-evidence="{{ app.evidence|e }}"
                data-fact-id="{{ app.fact_id }}"
                data-source="{{ app.source_document|e }}"
                data-confidence="{{ app.confidence_score }}"
                data-verified="{{ app.verified|string|lower }}"
                data-entity="{{ app.entity|default('target') }}">
                <td>
                    <strong>{{ app.name }}</strong>
                    {% if app.version %}<span class="text-muted text-sm"> v{{ app.version }}</span>{% endif %}
                </td>
                <td><span class="badge badge-category">{{ app.category.display_name }}</span></td>
                <td>{{ app.vendor or '-' }}</td>
                <td>
                    {% if app.deployment.value == 'saas' %}
                    <span class="badge badge-info">SaaS</span>
                    {% elif app.deployment.value == 'cloud' %}
                    <span class="badge badge-info">Cloud</span>
                    {% elif app.deployment.value == 'on_prem' %}
                    <span class="badge badge-secondary">On-Prem</span>
                    {% elif app.deployment.value == 'hybrid' %}
                    <span class="badge badge-warning">Hybrid</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>{{ "{:,}".format(app.user_count) if app.user_count > 0 else '-' }}</td>
                <td>
                    {% if app.criticality.value == 'critical' %}
                    <span class="badge badge-critical">CRITICAL</span>
                    {% elif app.criticality.value == 'high' %}
                    <span class="badge badge-high">HIGH</span>
                    {% elif app.criticality.value == 'medium' %}
                    <span class="badge badge-medium">MEDIUM</span>
                    {% elif app.criticality.value == 'low' %}
                    <span class="badge badge-low">LOW</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if app.source_document %}
                    <span class="source-doc text-sm" title="{{ app.source_document }}">{{ app.source_document[:20] }}{% if app.source_document|length > 20 %}...{% endif %}</span>
                    {% else %}
                    <span class="text-muted text-sm">-</span>
                    {% endif %}
                </td>
                <td>
                    {% set conf = (app.confidence_score * 100)|int %}
                    {% if conf >= 80 %}
                    <span class="confidence-badge confidence-high" title="{{ conf }}% confidence">{{ conf }}%</span>
                    {% elif conf >= 50 %}
                    <span class="confidence-badge confidence-medium" title="{{ conf }}% confidence">{{ conf }}%</span>
                    {% elif conf > 0 %}
                    <span class="confidence-badge confidence-low" title="{{ conf }}% confidence">{{ conf }}%</span>
                    {% else %}
                    <span class="text-muted text-sm">-</span>
                    {% endif %}
                    {% if app.verified %}
                    <span class="verified-badge" title="Verified">‚úì</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

</div><!-- End inventory-view -->

<!-- Report View -->
<div id="report-view" style="display: none;">
    <div class="report-container">
        <div class="report-content">
            <div class="report-loading">
                <div class="loading-spinner"></div>
                <p>Generating report narrative...</p>
            </div>
        </div>
        <div class="report-actions" style="display: none;">
            <button class="btn btn-secondary" onclick="regenerateNarrative()">Regenerate Narrative</button>
            <button class="btn btn-outline" onclick="copyNarrative()">Copy to Clipboard</button>
        </div>
    </div>
</div>

<style>
.categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.category-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 12px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
}

.category-card:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.category-icon {
    font-size: 2.5em;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-surface-sunken);
    border-radius: 12px;
}

.category-info {
    flex: 1;
}

.category-info h3 {
    margin: 0 0 5px 0;
    font-size: 1.1em;
}

.category-stats {
    display: flex;
    gap: 10px;
    align-items: center;
}

.category-count {
    color: var(--text-secondary);
    font-size: 0.9em;
}

.category-users {
    color: var(--text-muted);
    font-size: 0.85em;
    margin-top: 4px;
}

.category-arrow {
    color: var(--text-muted);
    font-size: 1.5em;
}

.badge-category {
    background: var(--bg-surface-sunken);
    color: var(--text-secondary);
    font-size: 0.8em;
}

.data-source-banner {
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 0.9em;
}

.data-source-analysis {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: #166534;
}

.data-source-demo {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: #92400e;
}

/* Confidence badges */
.confidence-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 600;
}

.confidence-high {
    background: rgba(34, 197, 94, 0.15);
    color: #166534;
}

.confidence-medium {
    background: rgba(245, 158, 11, 0.15);
    color: #92400e;
}

.confidence-low {
    background: rgba(239, 68, 68, 0.15);
    color: #991b1b;
}

.verified-badge {
    display: inline-block;
    margin-left: 4px;
    color: #166534;
    font-weight: bold;
}

.source-doc {
    color: var(--text-secondary);
    font-family: monospace;
    font-size: 0.8em;
}

/* Verification section in drawer */
.verification-section {
    margin-top: 20px;
    padding: 15px;
    background: var(--bg-surface-sunken);
    border-radius: 8px;
    border: 1px solid var(--border-default);
}

.verification-section h4 {
    margin: 0 0 10px 0;
    font-size: 0.9em;
    color: var(--text-secondary);
}

.verification-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.verified-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 6px;
}

.verified-indicator.is-verified {
    background: rgba(34, 197, 94, 0.15);
    color: #166534;
}

.verified-indicator.not-verified {
    background: rgba(245, 158, 11, 0.15);
    color: #92400e;
}

/* Entity Filter Styles */
.entity-filter {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-label {
    font-size: 0.85em;
    color: var(--text-muted);
    margin-right: 4px;
}

.entity-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border: 1px solid var(--border-default);
    border-radius: 6px;
    background: var(--bg-surface);
    color: var(--text-secondary);
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.2s;
}

.entity-btn:hover {
    border-color: var(--accent);
}

.entity-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
}

.entity-btn.entity-target.active {
    background: #10b981;
    border-color: #10b981;
}

.entity-btn.entity-buyer.active {
    background: #3b82f6;
    border-color: #3b82f6;
}

.entity-icon {
    font-size: 1em;
}

/* Entity indicator in table */
tr[data-entity="target"] td:first-child::before {
    content: "üéØ";
    margin-right: 6px;
    font-size: 0.85em;
}

tr[data-entity="buyer"] td:first-child::before {
    content: "üè¢";
    margin-right: 6px;
    font-size: 0.85em;
}

/* Row filtering */
tr.entity-hidden {
    display: none !important;
}

@media (max-width: 768px) {
    .controls-row {
        flex-direction: column;
        align-items: flex-start;
    }
    .entity-filter {
        width: 100%;
        justify-content: flex-start;
    }
}
</style>

{% endblock %}

{% block scripts %}
<script>
// View Toggle Functionality
let narrativeLoaded = false;
const domain = 'applications';

// Entity Filter Functionality
let currentEntityFilter = 'all';

document.querySelectorAll('.entity-filter .entity-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const entity = this.dataset.entity;
        currentEntityFilter = entity;

        // Update active button
        document.querySelectorAll('.entity-filter .entity-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // Filter table rows
        filterByEntity(entity);

        // Update summary stats
        updateEntitySummary(entity);
    });
});

function filterByEntity(entity) {
    const rows = document.querySelectorAll('table.table tbody tr');
    let visibleCount = 0;

    rows.forEach(row => {
        const rowEntity = row.dataset.entity || 'target';

        if (entity === 'all' || rowEntity === entity) {
            row.classList.remove('entity-hidden');
            visibleCount++;
        } else {
            row.classList.add('entity-hidden');
        }
    });

    // Update visible count display if exists
    const countDisplay = document.getElementById('visible-count');
    if (countDisplay) {
        countDisplay.textContent = visibleCount;
    }
}

function updateEntitySummary(entity) {
    // Could update the summary stats based on filtered entity
    // For now, just log the filter change
    console.log('Entity filter changed to:', entity);
}

document.querySelectorAll('.view-toggle-container .tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const view = this.dataset.view;

        // Update active tab
        document.querySelectorAll('.view-toggle-container .tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // Toggle views
        document.getElementById('inventory-view').style.display = view === 'inventory' ? 'block' : 'none';
        document.getElementById('report-view').style.display = view === 'report' ? 'block' : 'none';

        // Load narrative if switching to report view and not already loaded
        if (view === 'report' && !narrativeLoaded) {
            loadNarrative();
        }
    });
});

async function loadNarrative() {
    const container = document.querySelector('.report-content');
    const actions = document.querySelector('.report-actions');

    container.innerHTML = `
        <div class="report-loading">
            <div class="loading-spinner"></div>
            <p>Generating report narrative...</p>
        </div>
    `;
    actions.style.display = 'none';

    try {
        const response = await fetch(`/api/narrative/${domain}`);
        const data = await response.json();

        if (data.status === 'success') {
            renderNarrative(data);
            narrativeLoaded = true;
            actions.style.display = 'flex';
        } else if (data.status === 'placeholder') {
            renderPlaceholder(data);
        } else {
            container.innerHTML = `
                <div class="report-error">
                    <p><strong>Error generating narrative:</strong></p>
                    <p>${data.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="report-error">
                <p><strong>Failed to load narrative:</strong></p>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function renderNarrative(narrative) {
    const container = document.querySelector('.report-content');
    container.innerHTML = `
        <div class="report-section">
            <h3>Key Takeaway</h3>
            <p class="report-so-what report-editable" contenteditable="true">${narrative.so_what || 'No summary available'}</p>
        </div>

        ${narrative.considerations && narrative.considerations.length > 0 ? `
        <div class="report-section">
            <h3>Key Considerations</h3>
            <ul class="report-considerations">
                ${narrative.considerations.map(c => `<li class="report-editable" contenteditable="true">${c}</li>`).join('')}
            </ul>
        </div>
        ` : ''}

        <div class="report-section">
            <h3>Narrative</h3>
            <div class="report-narrative report-editable" contenteditable="true">${narrative.narrative || 'No detailed narrative available'}</div>
        </div>

        ${narrative.cost_summary ? `
        <div class="report-section">
            <h3>Cost Summary</h3>
            <div class="report-cost-summary report-editable" contenteditable="true">${narrative.cost_summary}</div>
        </div>
        ` : ''}

        ${narrative.key_facts && narrative.key_facts.length > 0 ? `
        <div class="report-section">
            <h3>Supporting Facts</h3>
            <ul class="report-key-facts">
                ${narrative.key_facts.map(f => `<li>${f}</li>`).join('')}
            </ul>
        </div>
        ` : ''}

        <div class="report-meta">
            <span class="confidence-badge confidence-${narrative.confidence === 'high' ? 'high' : narrative.confidence === 'medium' ? 'medium' : 'low'}">
                Confidence: ${narrative.confidence || 'medium'}
            </span>
        </div>
    `;
}

function renderPlaceholder(data) {
    const container = document.querySelector('.report-content');
    container.innerHTML = `
        <div class="report-placeholder">
            <h3>${data.so_what}</h3>
            <ul>
                ${data.considerations.map(c => `<li>${c}</li>`).join('')}
            </ul>
            <p class="text-muted">${data.narrative}</p>
        </div>
    `;
}

async function regenerateNarrative() {
    narrativeLoaded = false;
    const container = document.querySelector('.report-content');
    const actions = document.querySelector('.report-actions');

    container.innerHTML = `
        <div class="report-loading">
            <div class="loading-spinner"></div>
            <p>Regenerating narrative...</p>
        </div>
    `;
    actions.style.display = 'none';

    try {
        const response = await fetch(`/api/narrative/${domain}/regenerate`, { method: 'POST' });
        const data = await response.json();

        if (data.status === 'success') {
            renderNarrative(data);
            narrativeLoaded = true;
            actions.style.display = 'flex';
        } else {
            container.innerHTML = `
                <div class="report-error">
                    <p><strong>Error regenerating narrative:</strong></p>
                    <p>${data.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="report-error">
                <p><strong>Failed to regenerate narrative:</strong></p>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function copyNarrative() {
    const soWhat = document.querySelector('.report-so-what')?.innerText || '';
    const narrative = document.querySelector('.report-narrative')?.innerText || '';
    const considerations = Array.from(document.querySelectorAll('.report-considerations li'))
        .map(li => '- ' + li.innerText).join('\n');

    const fullText = `KEY TAKEAWAY:\n${soWhat}\n\nKEY CONSIDERATIONS:\n${considerations}\n\nNARRATIVE:\n${narrative}`;

    navigator.clipboard.writeText(fullText).then(() => {
        alert('Narrative copied to clipboard!');
    }).catch(err => {
        alert('Failed to copy: ' + err.message);
    });
}

// Row Selection for Inventory View
document.addEventListener('rowSelected', function(e) {
    const row = e.detail.row;
    const data = row.dataset;
    const confidence = Math.round(parseFloat(data.confidence || 0) * 100);
    const isVerified = data.verified === 'true';

    // Determine confidence level class
    let confClass = 'confidence-low';
    if (confidence >= 80) confClass = 'confidence-high';
    else if (confidence >= 50) confClass = 'confidence-medium';

    openDrawer(
        data.name,
        `
        <div class="drawer-section">
            <div class="drawer-section-title">Category</div>
            <div class="drawer-section-content">${data.category.replace('_', ' ')}</div>
        </div>
        <div class="drawer-section">
            <div class="drawer-section-title">Vendor</div>
            <div class="drawer-section-content">${data.vendor || 'Not specified'}</div>
        </div>
        <div class="drawer-section">
            <div class="drawer-section-title">Version</div>
            <div class="drawer-section-content">${data.version || 'Not specified'}</div>
        </div>
        <div class="drawer-section">
            <div class="drawer-section-title">Deployment</div>
            <div class="drawer-section-content">${data.deployment.replace('_', ' ').toUpperCase()}</div>
        </div>
        <div class="drawer-section">
            <div class="drawer-section-title">User Count</div>
            <div class="drawer-section-content">${parseInt(data.users).toLocaleString() || '-'}</div>
        </div>
        <div class="drawer-section">
            <div class="drawer-section-title">Criticality</div>
            <div class="drawer-section-content">
                <span class="badge badge-${data.criticality}">${data.criticality.toUpperCase()}</span>
            </div>
        </div>

        <!-- Evidence Traceability Section -->
        <div class="verification-section">
            <h4>üìã Evidence & Traceability</h4>
            <div class="drawer-section">
                <div class="drawer-section-title">Source Document</div>
                <div class="drawer-section-content font-mono" style="font-size: 0.85em;">
                    ${data.source || '<span class="text-muted">Source not tracked</span>'}
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Evidence Quote</div>
                <div class="drawer-section-content" style="font-style: italic; background: var(--bg-surface); padding: 10px; border-radius: 6px; border-left: 3px solid var(--accent);">
                    ${data.evidence ? '"' + data.evidence + '"' : '<span class="text-muted">No evidence quote captured</span>'}
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Confidence Score</div>
                <div class="drawer-section-content">
                    <span class="confidence-badge ${confClass}">${confidence}%</span>
                    <span class="text-muted text-sm" style="margin-left: 8px;">
                        ${confidence >= 80 ? 'High confidence - strong evidence' :
                          confidence >= 50 ? 'Medium confidence - partial evidence' :
                          'Low confidence - needs verification'}
                    </span>
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Verification Status</div>
                <div class="verification-status">
                    <span class="verified-indicator ${isVerified ? 'is-verified' : 'not-verified'}">
                        ${isVerified ? '‚úì Verified' : '‚óã Not Verified'}
                    </span>
                </div>
                ${!isVerified ? `
                <div class="text-sm text-muted">
                    This fact has not been human-verified. Review the evidence and source document before relying on this information.
                </div>
                ` : ''}
            </div>
        </div>

        <div class="drawer-section" style="margin-top: 15px;">
            <div class="drawer-section-title">Fact ID</div>
            <div class="drawer-section-content font-mono">
                <a href="{{ url_for('facts') }}?q=${data.factId}" class="fact-link">${data.factId}</a>
            </div>
        </div>
        `,
        `
        ${!isVerified ? `<button class="btn btn-primary" onclick="verifyFact('${data.factId}')">‚úì Verify This Fact</button>` : ''}
        <button class="btn btn-secondary" onclick="closeDrawer()">Close</button>
        `
    );
});

async function verifyFact(factId) {
    try {
        const response = await fetch(`/api/facts/${factId}/verify`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({verified_by: 'web_user'})
        });

        const result = await response.json();

        if (result.status === 'success') {
            // Update the row's data attribute
            const row = document.querySelector(`tr[data-fact-id="${factId}"]`);
            if (row) {
                row.dataset.verified = 'true';
                // Add verified badge to confidence cell
                const confCell = row.querySelector('td:last-child');
                if (confCell && !confCell.querySelector('.verified-badge')) {
                    confCell.innerHTML += '<span class="verified-badge" title="Verified">‚úì</span>';
                }
            }
            // Close and reopen drawer to show updated status
            closeDrawer();
            alert('Fact verified successfully!');
        } else {
            alert('Failed to verify fact: ' + result.message);
        }
    } catch (error) {
        alert('Error verifying fact: ' + error.message);
    }
}
</script>
{% endblock %}
