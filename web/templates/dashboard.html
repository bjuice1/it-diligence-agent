{% extends "base.html" %}

{% block title %}Dashboard - IT Due Diligence{% endblock %}

{% block content %}
<div class="page-header">
    <div class="flex justify-between items-start">
        <div>
            <h1>Analysis Dashboard</h1>
            <p>Overview of IT due diligence findings for this deal</p>
        </div>
        <div class="flex gap-2">
            {% if analysis_metadata %}
            <span class="text-sm text-muted" style="line-height: 2.5;">
                Analyzed {{ analysis_metadata.file_count }} file(s)
                {% if analysis_metadata.timestamp %}
                on {{ analysis_metadata.timestamp }}
                {% endif %}
            </span>
            {% endif %}
            <a href="{{ url_for('upload_documents') }}" class="btn btn-secondary btn-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                New Analysis
            </a>
        </div>
    </div>
</div>

{% if summary.facts == 0 and summary.risks == 0 %}
<!-- Empty State - No Analysis -->
<div class="card" style="text-align: center; padding: 60px 40px;">
    <div style="font-size: 4em; margin-bottom: 20px;">ðŸ“Š</div>
    <h2 style="margin-bottom: 10px;">No Analysis Results</h2>
    <p class="text-muted" style="margin-bottom: 30px; max-width: 400px; margin-left: auto; margin-right: auto;">
        Upload documents to start analyzing IT infrastructure, security, applications, and organization.
    </p>
    <a href="{{ url_for('upload_documents') }}" class="btn btn-primary btn-lg">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        Upload Documents
    </a>
</div>
{% else %}

<!-- Metrics Row -->
<div class="metrics-row">
    <div class="metric-card">
        <span class="metric-label">Facts Discovered</span>
        <span class="metric-value">{{ summary.facts }}</span>
        <span class="metric-subtext">Across {{ summary.domains_with_facts|length if summary.domains_with_facts else 0 }} domains</span>
    </div>
    <div class="metric-card {{ 'metric-warning' if summary.gaps > 10 else '' }}">
        <span class="metric-label">Information Gaps</span>
        <span class="metric-value">{{ summary.gaps }}</span>
        <span class="metric-subtext">Requiring VDR requests</span>
    </div>
    <div class="metric-card {{ 'metric-danger' if summary.risk_summary.critical|default(0) > 0 else 'metric-warning' if summary.risk_summary.high|default(0) > 0 else '' }}">
        <span class="metric-label">Risks Identified</span>
        <span class="metric-value">{{ summary.risks }}</span>
        <span class="metric-subtext">
            {% if summary.risk_summary.critical|default(0) > 0 %}
            <span style="color: var(--danger);">{{ summary.risk_summary.critical }} critical</span>,
            {% endif %}
            {{ summary.risk_summary.high|default(0) }} high
        </span>
    </div>
    <div class="metric-card">
        <span class="metric-label">Work Items</span>
        <span class="metric-value">{{ summary.work_items }}</span>
        <span class="metric-subtext">{{ summary.cost_summary.Day_1.count|default(0) if summary.cost_summary else 0 }} for Day 1</span>
    </div>
</div>

<!-- Domain Coverage -->
{% if summary.domains_with_facts %}
<div class="card mb-4">
    <div class="card-header">
        <span class="card-title">Domain Coverage</span>
    </div>
    <div class="card-body">
        <div class="flex gap-2 flex-wrap">
            {% set all_domains = ['infrastructure', 'network', 'cybersecurity', 'applications', 'identity_access', 'organization'] %}
            {% for domain in all_domains %}
            <span class="badge {% if domain in summary.domains_with_facts %}badge-success{% else %}badge-outline{% endif %}"
                  style="padding: 8px 16px; font-size: 0.9em;">
                {% if domain in summary.domains_with_facts %}âœ“{% else %}â—‹{% endif %}
                {{ domain|replace('_', ' ')|title }}
            </span>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Main Content Grid -->
<div class="grid grid-2 gap-4">
    <!-- Cost Summary Card -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Cost Summary</span>
            <a href="{{ url_for('work_items') }}" class="link text-sm">View all work items</a>
        </div>
        <div class="card-body">
            <div class="table-container" style="border: none; box-shadow: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Phase</th>
                            <th>Items</th>
                            <th style="text-align: right;">Cost Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set total_count = 0 %}
                        {% set total_low = 0 %}
                        {% set total_high = 0 %}
                        {% for phase, data in summary.cost_summary.items() %}
                        {% set total_count = total_count + data.count %}
                        {% set total_low = total_low + data.low %}
                        {% set total_high = total_high + data.high %}
                        <tr style="cursor: default;">
                            <td>
                                <span class="badge badge-{{ phase|lower|replace('_', '') }}">{{ phase|replace('_', ' ') }}</span>
                            </td>
                            <td>{{ data.count }}</td>
                            <td style="text-align: right;" class="cost-range">${{ "{:,.0f}".format(data.low) }} - ${{ "{:,.0f}".format(data.high) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot style="background: var(--bg-surface-sunken);">
                        <tr style="cursor: default;">
                            <td><strong>Total</strong></td>
                            <td><strong>{{ summary.cost_summary.values()|sum(attribute='count') }}</strong></td>
                            <td style="text-align: right;" class="cost-range">
                                <strong>${{ "{:,.0f}".format(summary.cost_summary.values()|sum(attribute='low')) }} - ${{ "{:,.0f}".format(summary.cost_summary.values()|sum(attribute='high')) }}</strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Top Risks Card -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Top Risks</span>
            <a href="{{ url_for('risks') }}" class="link text-sm">View all risks</a>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if top_risks %}
            <div class="table-container" style="border: none; border-radius: 0; box-shadow: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Severity</th>
                            <th>Risk</th>
                            <th>Domain</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for risk in top_risks %}
                        <tr data-id="{{ risk.finding_id }}" data-type="risk">
                            <td>
                                <span class="badge badge-{{ risk.severity }}">{{ risk.severity|upper }}</span>
                            </td>
                            <td class="truncate" style="max-width: 200px;">{{ risk.title }}</td>
                            <td class="text-muted text-sm">{{ risk.domain|replace('_', ' ')|title }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">&#x1F389;</div>
                <div class="empty-state-title">No risks identified</div>
                <div class="empty-state-text">The analysis hasn't found any significant risks yet.</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Day 1 Work Items -->
<div class="card mt-4">
    <div class="card-header">
        <span class="card-title">Day 1 Work Items</span>
        <a href="{{ url_for('work_items') }}?phase=Day_1" class="link text-sm">View all Day 1 items</a>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if day1_items %}
        <div class="table-container" style="border: none; border-radius: 0; box-shadow: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Domain</th>
                        <th>Owner</th>
                        <th style="text-align: right;">Cost Estimate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wi in day1_items %}
                    <tr data-id="{{ wi.finding_id }}" data-type="work_item">
                        <td class="font-mono text-sm">{{ wi.finding_id }}</td>
                        <td class="truncate" style="max-width: 300px;">{{ wi.title }}</td>
                        <td class="text-muted text-sm">{{ wi.domain|replace('_', ' ')|title }}</td>
                        <td>
                            <span class="badge badge-outline badge-info">{{ wi.owner_type }}</span>
                        </td>
                        <td style="text-align: right;" class="cost-range">{{ wi.cost_estimate|replace('_', ' ') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">&#x2705;</div>
            <div class="empty-state-title">No Day 1 work items</div>
            <div class="empty-state-text">No critical items requiring immediate attention after close.</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="flex gap-3 mt-4 flex-wrap">
    <a href="/api/export/excel" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export to Excel
    </a>
    <a href="/api/export/json" class="btn btn-secondary" target="_blank">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
        </svg>
        Export JSON
    </a>
    <a href="{{ url_for('gaps') }}" class="btn btn-secondary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        Review Gaps ({{ summary.gaps }})
    </a>
    <a href="{{ url_for('export_vdr') }}" class="btn btn-secondary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        Generate VDR Request
    </a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Store data for drawer
    const risksData = {
        {% for risk in top_risks %}
        "{{ risk.finding_id }}": {
            id: "{{ risk.finding_id }}",
            title: "{{ risk.title|e }}",
            severity: "{{ risk.severity }}",
            domain: "{{ risk.domain }}",
            description: "{{ risk.description|e if risk.description else 'No description available' }}",
            mitigation: "{{ risk.mitigation|e if risk.mitigation else 'No mitigation specified' }}",
            based_on: "{{ risk.based_on_facts|join(', ') if risk.based_on_facts else 'N/A' }}"
        },
        {% endfor %}
    };

    const workItemsData = {
        {% for wi in day1_items %}
        "{{ wi.finding_id }}": {
            id: "{{ wi.finding_id }}",
            title: "{{ wi.title|e }}",
            domain: "{{ wi.domain }}",
            phase: "{{ wi.phase }}",
            owner: "{{ wi.owner_type }}",
            cost: "{{ wi.cost_estimate }}",
            description: "{{ wi.description|e if wi.description else 'No description available' }}",
            priority: "{{ wi.priority|default('medium') }}"
        },
        {% endfor %}
    };

    document.addEventListener('rowSelected', function(e) {
        const { id, row } = e.detail;
        const type = row.dataset.type;

        if (type === 'risk' && risksData[id]) {
            const r = risksData[id];
            openDrawer(
                r.title,
                `
                <div class="drawer-section">
                    <div class="drawer-section-title">Severity</div>
                    <div class="drawer-section-content">
                        <span class="badge badge-${r.severity}">${r.severity.toUpperCase()}</span>
                    </div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Domain</div>
                    <div class="drawer-section-content">${r.domain.replace('_', ' ')}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Description</div>
                    <div class="drawer-section-content">${r.description}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Mitigation</div>
                    <div class="drawer-section-content">${r.mitigation}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Based On Facts</div>
                    <div class="drawer-section-content font-mono text-sm">${r.based_on}</div>
                </div>
                `,
                `<a href="{{ url_for('risk_detail', risk_id='') }}${r.id}" class="btn btn-primary">View Full Details</a>`
            );
        } else if (type === 'work_item' && workItemsData[id]) {
            const w = workItemsData[id];
            openDrawer(
                w.title,
                `
                <div class="drawer-section">
                    <div class="drawer-section-title">Phase</div>
                    <div class="drawer-section-content">
                        <span class="badge badge-${w.phase.toLowerCase().replace('_', '')}">${w.phase.replace('_', ' ')}</span>
                    </div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Owner</div>
                    <div class="drawer-section-content">${w.owner}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Cost Estimate</div>
                    <div class="drawer-section-content font-mono">${w.cost.replace(/_/g, ' ')}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Description</div>
                    <div class="drawer-section-content">${w.description}</div>
                </div>
                `,
                `<a href="{{ url_for('work_item_detail', wi_id='') }}${w.id}" class="btn btn-primary">View Full Details</a>`
            );
        }
    });
</script>
{% endblock %}
