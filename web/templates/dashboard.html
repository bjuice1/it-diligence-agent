{% extends "base.html" %}

{% block title %}Dashboard - IT Due Diligence{% endblock %}

{% block content %}
<div class="page-header">
    <div class="flex justify-between items-start">
        <div>
            <h1>Analysis Dashboard</h1>
            <p>Overview of IT due diligence findings for this deal</p>
        </div>
        <div class="flex gap-2">
            {% if analysis_metadata %}
            <div class="text-sm" style="line-height: 1.5; text-align: right;">
                {% if analysis_metadata.source == 'current_analysis' %}
                <span style="color: var(--success);">Current Analysis</span><br>
                {% else %}
                <span style="color: var(--warning);">Loaded from: {{ analysis_metadata.source_file }}</span><br>
                {% endif %}
                <span class="text-muted">
                    {{ analysis_metadata.fact_count or analysis_metadata.file_count }} facts
                    {% if analysis_metadata.timestamp %}
                    | {{ analysis_metadata.timestamp }}
                    {% endif %}
                </span>
            </div>
            {% endif %}
            <a href="{{ url_for('upload_documents') }}" class="btn btn-secondary btn-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                New Analysis
            </a>
        </div>
    </div>
</div>

{% if summary.facts == 0 and summary.risks == 0 and (not pending_summary or pending_summary.total == 0) %}
<!-- Empty State - No Analysis -->
<div class="card" style="text-align: center; padding: 60px 40px;">
    <div style="font-size: 4em; margin-bottom: 20px;">üìä</div>
    <h2 style="margin-bottom: 10px;">No Analysis Results</h2>
    <p class="text-muted" style="margin-bottom: 30px; max-width: 400px; margin-left: auto; margin-right: auto;">
        Upload documents to start analyzing IT infrastructure, security, applications, and organization.
    </p>
    <a href="{{ url_for('upload_documents') }}" class="btn btn-primary btn-lg">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        Upload Documents
    </a>
</div>
{% elif summary.facts == 0 and summary.risks == 0 and pending_summary and pending_summary.total > 0 %}
<!-- Pending Updates Only State -->
<div class="card mb-4" style="border-left: 4px solid var(--warning); background: rgba(234, 179, 8, 0.05);">
    <div class="card-body" style="padding: 24px;">
        <div class="flex justify-between items-center">
            <div>
                <h3 style="color: var(--warning); margin-bottom: 8px;">{{ pending_summary.total }} Document Updates Pending Review</h3>
                <p class="text-muted mb-0">
                    New facts have been extracted from uploaded documents. Review and approve them to add to your knowledge base.
                </p>
                <div class="flex gap-2 mt-3">
                    <span class="badge" style="background: rgba(234, 179, 8, 0.2); color: #b45309;">{{ pending_summary.tier2 }} batch review</span>
                    {% if pending_summary.tier3 > 0 %}
                    <span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #dc2626;">{{ pending_summary.tier3 }} conflicts</span>
                    {% endif %}
                </div>
            </div>
            <div class="flex gap-2">
                {% if pending_summary.tier2 > 0 %}
                <a href="/review/batch" class="btn" style="background: var(--warning); color: white;">
                    Review Batch
                </a>
                {% endif %}
                {% if pending_summary.tier3 > 0 %}
                <a href="/review/conflicts" class="btn btn-danger">
                    Resolve Conflicts
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="card" style="text-align: center; padding: 40px;">
    <p class="text-muted">Or run a full analysis to generate risks and work items</p>
    <a href="{{ url_for('upload_documents') }}" class="btn btn-secondary">
        Run Full Analysis
    </a>
</div>
{% else %}

<!-- Metrics Row -->
<div class="metrics-row">
    <div class="metric-card">
        <span class="metric-label">Facts Discovered</span>
        <span class="metric-value">{{ summary.facts }}</span>
        <span class="metric-subtext">Across {{ summary.domains_with_facts|length if summary.domains_with_facts else 0 }} domains</span>
    </div>
    <div class="metric-card {{ 'metric-warning' if summary.gaps > 10 else '' }}">
        <span class="metric-label">Information Gaps</span>
        <span class="metric-value">{{ summary.gaps }}</span>
        <span class="metric-subtext">Requiring VDR requests</span>
    </div>
    <div class="metric-card {{ 'metric-danger' if (summary.risk_summary|default({})).critical|default(0) > 0 else 'metric-warning' if (summary.risk_summary|default({})).high|default(0) > 0 else '' }}">
        <span class="metric-label">Risks Identified</span>
        <span class="metric-value">{{ summary.risks|default(0) }}</span>
        <span class="metric-subtext">
            {% if (summary.risk_summary|default({})).critical|default(0) > 0 %}
            <span style="color: var(--danger);">{{ (summary.risk_summary|default({})).critical }} critical</span>,
            {% endif %}
            {{ (summary.risk_summary|default({})).high|default(0) }} high
        </span>
    </div>
    <div class="metric-card">
        <span class="metric-label">Work Items</span>
        <span class="metric-value">{{ summary.work_items }}</span>
        <span class="metric-subtext">{{ summary.cost_summary.Day_1.count|default(0) if summary.cost_summary else 0 }} for Day 1</span>
    </div>
    {% if pending_summary and pending_summary.total > 0 %}
    <div class="metric-card metric-warning" style="cursor: pointer;" onclick="window.location='/documents'">
        <span class="metric-label">Pending Updates</span>
        <span class="metric-value">{{ pending_summary.total }}</span>
        <span class="metric-subtext">
            {% if pending_summary.tier3 > 0 %}<span style="color: var(--danger);">{{ pending_summary.tier3 }} conflicts</span>, {% endif %}
            {{ pending_summary.tier2 }} to review
        </span>
    </div>
    {% endif %}
</div>

<!-- Pending Updates Alert -->
{% if pending_summary and pending_summary.total > 0 %}
<div class="card mb-4" style="border-left: 4px solid var(--warning); background: rgba(234, 179, 8, 0.05);">
    <div class="card-body" style="padding: 16px 20px;">
        <div class="flex justify-between items-center">
            <div>
                <strong style="color: var(--warning);">Document Updates Pending Review</strong>
                <p class="text-muted text-sm mb-0">
                    {{ pending_summary.total }} new facts extracted from uploaded documents need review before being added to the knowledge base.
                </p>
            </div>
            <div class="flex gap-2">
                {% if pending_summary.tier2 > 0 %}
                <a href="/review/batch" class="btn btn-sm" style="background: var(--warning); color: white;">
                    Review {{ pending_summary.tier2 }} Batch
                </a>
                {% endif %}
                {% if pending_summary.tier3 > 0 %}
                <a href="/review/conflicts" class="btn btn-sm btn-danger">
                    Resolve {{ pending_summary.tier3 }} Conflicts
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Entity Summary -->
{% if entity_summary %}
<div class="card mb-4">
    <div class="card-header">
        <span class="card-title">Entity Analysis</span>
        <span class="text-muted text-sm">Facts by company</span>
    </div>
    <div class="card-body">
        <div class="entity-summary-grid">
            <div class="entity-box entity-target">
                <div class="entity-header-badge">
                    <span class="entity-icon-small">üéØ</span>
                    <span class="entity-name">TARGET</span>
                </div>
                <div class="entity-stats">
                    <div class="entity-stat">
                        <span class="stat-value">{{ entity_summary.target.fact_count }}</span>
                        <span class="stat-label">Facts</span>
                    </div>
                    <div class="entity-stat">
                        <span class="stat-value">{{ entity_summary.target.document_count }}</span>
                        <span class="stat-label">Documents</span>
                    </div>
                </div>
                {% if entity_summary.target.by_domain %}
                <div class="entity-domains">
                    {% for domain, count in entity_summary.target.by_domain.items() %}
                    {% if domain != 'applications' %}
                    <span class="domain-chip">{{ domain }}: {{ count }}</span>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="entity-box entity-buyer">
                <div class="entity-header-badge">
                    <span class="entity-icon-small">üè¢</span>
                    <span class="entity-name">BUYER</span>
                </div>
                <div class="entity-stats">
                    <div class="entity-stat">
                        <span class="stat-value">{{ entity_summary.buyer.fact_count }}</span>
                        <span class="stat-label">Facts</span>
                    </div>
                    <div class="entity-stat">
                        <span class="stat-value">{{ entity_summary.buyer.document_count }}</span>
                        <span class="stat-label">Documents</span>
                    </div>
                </div>
                {% if entity_summary.buyer.by_domain %}
                <div class="entity-domains">
                    {% for domain, count in entity_summary.buyer.by_domain.items() %}
                    <span class="domain-chip">{{ domain }}: {{ count }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<style>
.entity-summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
.entity-box {
    padding: 16px;
    border-radius: 8px;
    border: 2px solid var(--border-default);
}
.entity-target {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.05);
}
.entity-buyer {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.05);
}
.entity-header-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}
.entity-icon-small {
    font-size: 1.2em;
}
.entity-name {
    font-weight: 600;
    font-size: 0.9em;
    letter-spacing: 0.05em;
}
.entity-stats {
    display: flex;
    gap: 24px;
    margin-bottom: 12px;
}
.entity-stat {
    display: flex;
    flex-direction: column;
}
.entity-stat .stat-value {
    font-size: 1.5em;
    font-weight: 700;
}
.entity-stat .stat-label {
    font-size: 0.8em;
    color: var(--text-muted);
}
.entity-domains {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.domain-chip {
    font-size: 0.75em;
    padding: 3px 8px;
    background: var(--bg-surface);
    border-radius: 4px;
    color: var(--text-muted);
}
@media (max-width: 600px) {
    .entity-summary-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endif %}

<!-- Inventory Summary -->
{% if inventory_summary %}
<div class="card mb-4" style="border-left: 4px solid #2563eb;">
    <div class="card-header">
        <span class="card-title">Application Inventory</span>
        <a href="{{ url_for('inventory.inventory_home') }}" class="text-sm" style="color: var(--accent);">View Details ‚Üí</a>
    </div>
    <div class="card-body">
        <div class="flex gap-6 items-center">
            <div class="text-center">
                <div style="font-size: 2rem; font-weight: 700; color: var(--accent);">{{ inventory_summary.applications }}</div>
                <div class="text-muted text-sm">Applications</div>
            </div>
            <div class="text-center">
                <div style="font-size: 2rem; font-weight: 700; color: var(--accent);">${{ "{:,.0f}".format(inventory_summary.total_cost / 1000) }}K</div>
                <div class="text-muted text-sm">Annual Cost</div>
            </div>
            <div class="text-center">
                <div style="font-size: 2rem; font-weight: 700; color: var(--danger);">{{ inventory_summary.critical }}</div>
                <div class="text-muted text-sm">Critical Apps</div>
            </div>
            <div style="flex: 1; text-align: right;">
                <a href="{{ url_for('inventory.diagram') }}" class="btn btn-secondary btn-sm">View Data Flow Diagram</a>
                <a href="{{ url_for('inventory.insights') }}" class="btn btn-primary btn-sm" style="margin-left: 8px;">Insights Report</a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Domain Coverage -->
{% if summary.domains_with_facts %}
<div class="card mb-4">
    <div class="card-header">
        <span class="card-title">Domain Coverage</span>
    </div>
    <div class="card-body">
        <div class="flex gap-2 flex-wrap">
            {% set all_domains = ['infrastructure', 'network', 'cybersecurity', 'applications', 'identity_access', 'organization'] %}
            {% for domain in all_domains %}
            <span class="badge {% if domain in summary.domains_with_facts %}badge-success{% else %}badge-outline{% endif %}"
                  style="padding: 8px 16px; font-size: 0.9em;">
                {% if domain in summary.domains_with_facts %}‚úì{% else %}‚óã{% endif %}
                {{ domain|replace('_', ' ')|title }}
            </span>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Main Content Grid -->
<div class="grid grid-2 gap-4">
    <!-- Cost Summary Card -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Cost Summary</span>
            <a href="{{ url_for('work_items') }}" class="link text-sm">View all work items</a>
        </div>
        <div class="card-body">
            <div class="table-container" style="border: none; box-shadow: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Phase</th>
                            <th>Items</th>
                            <th style="text-align: right;">Cost Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set total_count = 0 %}
                        {% set total_low = 0 %}
                        {% set total_high = 0 %}
                        {% for phase, data in summary.cost_summary.items() %}
                        {% set total_count = total_count + data.count %}
                        {% set total_low = total_low + data.low %}
                        {% set total_high = total_high + data.high %}
                        <tr style="cursor: default;">
                            <td>
                                <span class="badge badge-{{ phase|lower|replace('_', '') }}">{{ phase|replace('_', ' ') }}</span>
                            </td>
                            <td>{{ data.count }}</td>
                            <td style="text-align: right;" class="cost-range">${{ "{:,.0f}".format(data.low) }} - ${{ "{:,.0f}".format(data.high) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot style="background: var(--bg-surface-sunken);">
                        <tr style="cursor: default;">
                            <td><strong>Total</strong></td>
                            <td><strong>{{ summary.cost_summary.values()|sum(attribute='count') }}</strong></td>
                            <td style="text-align: right;" class="cost-range">
                                <strong>${{ "{:,.0f}".format(summary.cost_summary.values()|sum(attribute='low')) }} - ${{ "{:,.0f}".format(summary.cost_summary.values()|sum(attribute='high')) }}</strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Top Risks Card -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Top Risks</span>
            <a href="{{ url_for('risks') }}" class="link text-sm">View all risks</a>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if top_risks %}
            <div class="table-container" style="border: none; border-radius: 0; box-shadow: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Severity</th>
                            <th>Risk</th>
                            <th>Domain</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for risk in top_risks %}
                        <tr data-id="{{ risk.finding_id }}" data-type="risk">
                            <td>
                                <span class="badge badge-{{ risk.severity }}">{{ risk.severity|upper }}</span>
                            </td>
                            <td class="truncate" style="max-width: 200px;">{{ risk.title }}</td>
                            <td class="text-muted text-sm">{{ risk.domain|replace('_', ' ')|title }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">&#x1F389;</div>
                <div class="empty-state-title">No risks identified</div>
                <div class="empty-state-text">The analysis hasn't found any significant risks yet.</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Day 1 Work Items -->
<div class="card mt-4">
    <div class="card-header">
        <span class="card-title">Day 1 Work Items</span>
        <a href="{{ url_for('work_items') }}?phase=Day_1" class="link text-sm">View all Day 1 items</a>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if day1_items %}
        <div class="table-container" style="border: none; border-radius: 0; box-shadow: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Domain</th>
                        <th>Owner</th>
                        <th style="text-align: right;">Cost Estimate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wi in day1_items %}
                    <tr data-id="{{ wi.finding_id }}" data-type="work_item">
                        <td class="font-mono text-sm">{{ wi.finding_id }}</td>
                        <td class="truncate" style="max-width: 300px;">{{ wi.title }}</td>
                        <td class="text-muted text-sm">{{ wi.domain|replace('_', ' ')|title }}</td>
                        <td>
                            <span class="badge badge-outline badge-info">{{ wi.owner_type }}</span>
                        </td>
                        <td style="text-align: right;" class="cost-range">{{ wi.cost_estimate|replace('_', ' ') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">&#x2705;</div>
            <div class="empty-state-title">No Day 1 work items</div>
            <div class="empty-state-text">No critical items requiring immediate attention after close.</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="flex gap-3 mt-4 flex-wrap">
    <!-- Export Dropdown -->
    <div class="export-dropdown-container">
        <button class="btn btn-primary" onclick="toggleExportDropdown(this)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
        <div class="export-dropdown-menu">
            <div class="export-dropdown-header">Quick Exports</div>
            <a href="/api/export/excel" class="export-dropdown-item">
                <span class="format-badge">XLS</span> Full Analysis Excel
            </a>
            <a href="/api/export/json" class="export-dropdown-item">
                <span class="format-badge">JSON</span> Full Analysis JSON
            </a>
            <div class="export-dropdown-divider"></div>
            <div class="export-dropdown-header">Dossiers (Complete Detail)</div>
            <a href="/api/export/dossiers/all?format=html" class="export-dropdown-item">
                <span class="format-badge">HTML</span> All Dossiers (Interactive)
            </a>
            <a href="/api/export/dossiers/all?format=md" class="export-dropdown-item">
                <span class="format-badge">MD</span> All Dossiers (Markdown)
            </a>
            <div class="export-dropdown-divider"></div>
            <a href="{{ url_for('exports_page') }}" class="export-dropdown-item export-dropdown-more">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                Export Center (More Options)
            </a>
        </div>
    </div>
    <a href="{{ url_for('gaps') }}" class="btn btn-secondary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        Review Gaps ({{ summary.gaps }})
    </a>
    <a href="{{ url_for('export_vdr') }}" class="btn btn-secondary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        Generate VDR Request
    </a>
    <a href="{{ url_for('inventory.inventory_home') }}" class="btn btn-secondary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
        </svg>
        Inventory &amp; Data Flows
    </a>
</div>

<style>
.export-dropdown-container {
    position: relative;
    display: inline-block;
}
.export-dropdown-container .export-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 260px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.15s ease;
    z-index: 100;
    margin-top: 4px;
}
.export-dropdown-container.open .export-dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
.export-dropdown-header {
    padding: 8px 14px 4px;
    font-size: 0.7em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
}
.export-dropdown-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    color: var(--text-primary);
    text-decoration: none;
    font-size: 0.9em;
    transition: background 0.1s;
}
.export-dropdown-item:hover {
    background: var(--bg-surface-sunken);
}
.export-dropdown-divider {
    height: 1px;
    background: var(--border-default);
    margin: 6px 0;
}
.export-dropdown-more {
    color: var(--accent);
    font-weight: 500;
}
.format-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 20px;
    font-size: 0.7em;
    font-weight: 600;
    background: var(--bg-surface-sunken);
    border-radius: 4px;
    color: var(--text-muted);
}
</style>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Store data for drawer
    const risksData = {
        {% for risk in top_risks %}
        "{{ risk.finding_id }}": {
            id: "{{ risk.finding_id }}",
            title: "{{ risk.title|e }}",
            severity: "{{ risk.severity }}",
            domain: "{{ risk.domain }}",
            description: "{{ risk.description|e if risk.description else 'No description available' }}",
            mitigation: "{{ risk.mitigation|e if risk.mitigation else 'No mitigation specified' }}",
            based_on: "{{ risk.based_on_facts|join(', ') if risk.based_on_facts else 'N/A' }}"
        },
        {% endfor %}
    };

    const workItemsData = {
        {% for wi in day1_items %}
        "{{ wi.finding_id }}": {
            id: "{{ wi.finding_id }}",
            title: "{{ wi.title|e }}",
            domain: "{{ wi.domain }}",
            phase: "{{ wi.phase }}",
            owner: "{{ wi.owner_type }}",
            cost: "{{ wi.cost_estimate }}",
            description: "{{ wi.description|e if wi.description else 'No description available' }}",
            priority: "{{ wi.priority|default('medium') }}"
        },
        {% endfor %}
    };

    document.addEventListener('rowSelected', function(e) {
        const { id, row } = e.detail;
        const type = row.dataset.type;

        if (type === 'risk' && risksData[id]) {
            const r = risksData[id];
            openDrawer(
                r.title,
                `
                <div class="drawer-section">
                    <div class="drawer-section-title">Severity</div>
                    <div class="drawer-section-content">
                        <span class="badge badge-${r.severity}">${r.severity.toUpperCase()}</span>
                    </div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Domain</div>
                    <div class="drawer-section-content">${r.domain.replace('_', ' ')}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Description</div>
                    <div class="drawer-section-content">${r.description}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Mitigation</div>
                    <div class="drawer-section-content">${r.mitigation}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Based On Facts</div>
                    <div class="drawer-section-content font-mono text-sm">${r.based_on}</div>
                </div>
                `,
                `<a href="{{ url_for('risk_detail', risk_id='') }}${r.id}" class="btn btn-primary">View Full Details</a>`
            );
        } else if (type === 'work_item' && workItemsData[id]) {
            const w = workItemsData[id];
            openDrawer(
                w.title,
                `
                <div class="drawer-section">
                    <div class="drawer-section-title">Phase</div>
                    <div class="drawer-section-content">
                        <span class="badge badge-${w.phase.toLowerCase().replace('_', '')}">${w.phase.replace('_', ' ')}</span>
                    </div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Owner</div>
                    <div class="drawer-section-content">${w.owner}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Cost Estimate</div>
                    <div class="drawer-section-content font-mono">${w.cost.replace(/_/g, ' ')}</div>
                </div>
                <div class="drawer-section">
                    <div class="drawer-section-title">Description</div>
                    <div class="drawer-section-content">${w.description}</div>
                </div>
                `,
                `<a href="{{ url_for('work_item_detail', wi_id='') }}${w.id}" class="btn btn-primary">View Full Details</a>`
            );
        }
    });

    // Export dropdown toggle
    function toggleExportDropdown(trigger) {
        const container = trigger.closest('.export-dropdown-container');
        // Close all other dropdowns first
        document.querySelectorAll('.export-dropdown-container.open').forEach(d => {
            if (d !== container) {
                d.classList.remove('open');
            }
        });
        container.classList.toggle('open');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.export-dropdown-container')) {
            document.querySelectorAll('.export-dropdown-container.open').forEach(d => {
                d.classList.remove('open');
            });
        }
    });
</script>
{% endblock %}
