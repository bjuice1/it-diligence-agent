{% extends "base.html" %}

{% block title %}{{ risk.title }} - Risk Detail{% endblock %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <a href="{{ url_for('risks') }}" class="btn btn-ghost btn-sm">&larr; Back to Risks</a>
        <h1>Risk Detail</h1>
    </div>
</div>

<div class="risk-detail-container">
    <!-- Risk Header -->
    <div class="risk-header">
        <div class="risk-severity">
            <span class="badge badge-{{ risk.severity }} badge-lg">{{ risk.severity|upper }}</span>
        </div>
        <div class="risk-title-section">
            <h2>{{ risk.title }}</h2>
            <div class="risk-meta">
                <span class="risk-id font-mono">{{ risk.finding_id }}</span>
                <span class="risk-domain">{{ risk.domain|replace('_', ' ')|title }}</span>
            </div>
        </div>
    </div>

    <!-- Risk Description + Inline Context (MVP Enhancement) -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Description</h3>
        </div>
        <div class="card-body">
            <p>{{ risk.description }}</p>

            <!-- NEW: Inline Reasoning (MVP Feature) -->
            {% if risk_reasoning %}
            <div class="inline-context">
                <span class="context-icon">üí°</span>
                <span class="context-text">{{ risk_reasoning.split('.')[0] + '.' if '.' in risk_reasoning else (risk_reasoning[:100] + '...' if risk_reasoning|length > 100 else risk_reasoning) }}</span>
            </div>
            {% endif %}

            <!-- NEW: Action Buttons (MVP Feature) -->
            <div class="inline-actions">
                {% if (mna_context and mna_context.implication) or risk_mitigation or risk_reasoning %}
                <button class="btn btn-link btn-sm" onclick="toggleDetails()" id="explainBtn">
                    <span id="explainBtnText">Explain This ‚ñº</span>
                </button>
                {% endif %}

                {% if has_cost_data %}
                <button class="btn btn-link btn-sm" onclick="openCostModal()">
                    View Calculation ‚ñ∂
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- NEW: Expandable Details Section (MVP Feature) -->
    <div id="expandedDetails" class="expanded-details-section" style="display: none;">
        <!-- M&A Implications -->
        {% if mna_context and (mna_context.implication or mna_context.timeline) %}
        <div class="card mb-4 mna-card">
        <div class="card-header">
            <h3>M&A Deal Implications</h3>
        </div>
        <div class="card-body">
            {% if mna_context.lens %}
            <div class="mna-lens mb-3">
                <span class="lens-label">Analysis Lens:</span>
                <span class="lens-value">{{ mna_context.lens|replace('_', ' ')|title }}</span>
            </div>
            {% endif %}

            {% if mna_context.implication %}
            <div class="mna-implication mb-3">
                <div class="section-label">Deal Impact</div>
                <p class="implication-text">{{ mna_context.implication }}</p>
            </div>
            {% endif %}

            {% if mna_context.timeline %}
            <div class="mna-timeline">
                <span class="timeline-icon">‚è±Ô∏è</span>
                <span class="timeline-label">Timeline:</span>
                <span class="timeline-value">{{ mna_context.timeline }}</span>
            </div>
            {% endif %}

            {% if mna_context.confidence %}
            <div class="mna-confidence mt-2">
                <span class="confidence-label">Confidence:</span>
                <span class="badge badge-{{ 'low' if mna_context.confidence == 'high' else 'medium' if mna_context.confidence == 'medium' else 'critical' }}">{{ mna_context.confidence|upper }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Mitigation -->
    {% if risk.mitigation %}
    <div class="card mb-4">
        <div class="card-header">
            <h3>Recommended Mitigation</h3>
        </div>
        <div class="card-body">
            <p>{{ risk.mitigation }}</p>
        </div>
    </div>
    {% endif %}
    </div>
    <!-- END: Expandable Details Section -->

    <!-- Evidence Chain Section -->
    <div class="card mb-4 evidence-chain-card">
        <div class="card-header">
            <h3>Evidence Chain - Why This Conclusion?</h3>
            <p class="text-muted text-sm mt-1">Trace this risk back to its source evidence</p>
        </div>
        <div class="card-body">
            <!-- Reasoning -->
            {% if risk.reasoning %}
            <div class="reasoning-section mb-4">
                <div class="section-label">Analysis Reasoning</div>
                <div class="reasoning-content">
                    {{ risk.reasoning|replace('‚Üí', '<span class="reasoning-arrow">‚Üí</span>')|safe }}
                </div>
            </div>
            {% endif %}

            <!-- Supporting Facts -->
            <div class="facts-section">
                <div class="section-label">Supporting Facts ({{ facts|length }})</div>
                {% if facts %}
                <div class="facts-list">
                    {% for fact in facts %}
                    <div class="fact-card">
                        <div class="fact-header">
                            <span class="fact-id font-mono">{{ fact.fact_id }}</span>
                            <span class="fact-domain">{{ fact.domain|replace('_', ' ')|title }}</span>
                        </div>
                        <div class="fact-item">{{ fact.item }}</div>

                        {% if fact.evidence %}
                        <div class="fact-evidence">
                            <div class="evidence-label">Exact Quote from VDR Document</div>
                            <blockquote class="evidence-quote">
                                {{ fact.evidence.exact_quote if fact.evidence.exact_quote else 'No quote available' }}
                            </blockquote>
                            {% if fact.evidence.source_section %}
                            <div class="evidence-source">
                                <strong>Section:</strong> {{ fact.evidence.source_section }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if fact.source_document %}
                        <div class="fact-source-doc">
                            <strong>Source Document(s):</strong>
                            <div class="source-docs">
                                {% for doc in fact.source_document.split(', ') %}
                                <span class="source-doc-chip">{{ doc.split('_', 1)[1] if '_' in doc else doc }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if fact.details %}
                        <div class="fact-details">
                            <div class="details-toggle" onclick="this.parentElement.classList.toggle('expanded')">
                                Show extracted data
                            </div>
                            <div class="details-content">
                                {% for key, value in fact.details.items() %}
                                <div class="detail-row">
                                    <span class="detail-key">{{ key }}:</span>
                                    <span class="detail-value">{{ value }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-muted">No supporting facts linked to this risk.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Affected Inventory Items -->
    {% if affected_items %}
    <div class="card mb-4 affected-items-card">
        <div class="card-header">
            <h3>Affected Inventory Items ({{ affected_items|length }})</h3>
            <p class="text-muted text-sm mt-1">Applications and systems referenced by this risk</p>
        </div>
        <div class="card-body">
            <!-- Cost Impact Summary -->
            {% if affected_cost_total > 0 or affected_users_total > 0 %}
            <div class="cost-impact-summary mb-4">
                <div class="cost-impact-header">Combined Impact</div>
                <div class="cost-impact-stats">
                    {% if affected_cost_total > 0 %}
                    <div class="impact-stat">
                        <div class="stat-value">${{ "{:,.0f}".format(affected_cost_total) }}</div>
                        <div class="stat-label">Annual Cost</div>
                    </div>
                    {% endif %}
                    {% if affected_users_total > 0 %}
                    <div class="impact-stat">
                        <div class="stat-value">{{ "{:,}".format(affected_users_total) }}</div>
                        <div class="stat-label">Users Affected</div>
                    </div>
                    {% endif %}
                    <div class="impact-stat">
                        <div class="stat-value">{{ affected_items|length }}</div>
                        <div class="stat-label">Systems</div>
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="affected-items-grid">
                {% for item in affected_items %}
                <div class="affected-item">
                    <div class="affected-item-header">
                        <span class="item-type-badge {{ item.inventory_type }}">{{ item.inventory_type|upper }}</span>
                        {% if item.criticality and 'critical' in item.criticality|lower %}
                        <span class="badge badge-critical">CRITICAL</span>
                        {% elif item.criticality and 'high' in item.criticality|lower %}
                        <span class="badge badge-high">HIGH</span>
                        {% endif %}
                    </div>
                    <div class="affected-item-name">{{ item.name }}</div>
                    <div class="affected-item-details">
                        {% if item.data.vendor %}<span>{{ item.data.vendor }}</span>{% endif %}
                        {% if item.cost %}<span class="item-cost">${{ "{:,.0f}".format(item.cost) }}/yr</span>{% endif %}
                        {% if item.data.users %}<span>{{ item.data.users }} users</span>{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Related Work Items -->
    {% if related_work_items %}
    <div class="card mb-4">
        <div class="card-header">
            <h3>Related Work Items</h3>
        </div>
        <div class="card-body">
            <ul class="work-items-list">
                {% for wi in related_work_items %}
                <li>
                    <span class="badge badge-outline">{{ wi.phase }}</span>
                    {{ wi.title }}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="card">
        <div class="card-header">
            <h3>Actions</h3>
        </div>
        <div class="card-body">
            <div class="actions-row">
                <form action="{{ url_for('adjust_risk', risk_id=risk.finding_id) }}" method="POST" class="inline-form">
                    <label for="severity">Adjust Severity:</label>
                    <select name="severity" id="severity" class="filter-select">
                        <option value="critical" {{ 'selected' if risk.severity == 'critical' }}>Critical</option>
                        <option value="high" {{ 'selected' if risk.severity == 'high' }}>High</option>
                        <option value="medium" {{ 'selected' if risk.severity == 'medium' }}>Medium</option>
                        <option value="low" {{ 'selected' if risk.severity == 'low' }}>Low</option>
                    </select>
                    <button type="submit" class="btn btn-secondary btn-sm">Update</button>
                </form>
            </div>
            <div class="actions-row mt-3">
                <form action="{{ url_for('add_risk_note', risk_id=risk.finding_id) }}" method="POST" class="note-form">
                    <label for="note">Add Note:</label>
                    <textarea name="note" id="note" rows="2" class="filter-input" placeholder="Add your analysis note..."></textarea>
                    <button type="submit" class="btn btn-secondary btn-sm mt-2">Add Note</button>
                </form>
            </div>
        </div>
    </div>

    <!-- NEW: Cost Breakdown Modal (MVP Feature) -->
    {% if risk.cost_buildup_json %}
    <div id="costModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeCostModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cost Breakdown</h3>
                <button class="modal-close" onclick="closeCostModal()">&times;</button>
            </div>
            <div class="modal-body">
                {% set cost = risk.cost_buildup_json %}

                <!-- Total Cost Range -->
                <div class="cost-total">
                    <div class="cost-label">Estimated Cost Range</div>
                    <div class="cost-value">
                        {% if cost.cost_low and cost.cost_high %}
                        ${{ "{:,.0f}".format(cost.cost_low) }} - ${{ "{:,.0f}".format(cost.cost_high) }}
                        {% elif cost.cost_low %}
                        ${{ "{:,.0f}".format(cost.cost_low) }}
                        {% else %}
                        Not specified
                        {% endif %}
                    </div>
                </div>

                <!-- Calculation Method -->
                {% if cost.estimation_method %}
                <div class="cost-section">
                    <div class="section-label">Estimation Method</div>
                    <div class="estimation-method-badge">{{ cost.estimation_method|replace('_', ' ')|title }}</div>
                </div>
                {% endif %}

                <!-- Formula (if available) -->
                {% if cost.quantity and cost.unit_cost_low %}
                <div class="cost-section">
                    <div class="section-label">Calculation Formula</div>
                    <div class="cost-formula">
                        {{ cost.quantity }} √ó ${{ "{:,.0f}".format(cost.unit_cost_low) }}
                        {% if cost.unit_cost_high %}
                        - ${{ "{:,.0f}".format(cost.unit_cost_high) }}
                        {% endif %}
                        = ${{ "{:,.0f}".format(cost.cost_low) }}
                        {% if cost.cost_high %}
                        - ${{ "{:,.0f}".format(cost.cost_high) }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Assumptions -->
                {% if cost.assumptions and cost.assumptions|length > 0 %}
                <div class="cost-section">
                    <div class="section-label">Assumptions</div>
                    <ul class="assumptions-list">
                        {% for assumption in cost.assumptions %}
                        <li>{{ assumption }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Cost Components Breakdown -->
                {% if cost.cost_components and cost.cost_components|length > 0 %}
                <div class="cost-section">
                    <div class="section-label">Cost Components</div>
                    <div class="cost-components-list">
                        {% for component in cost.cost_components %}
                        <div class="cost-component">
                            <span class="component-label">{{ component.label }}</span>
                            <span class="component-value">
                                ${{ "{:,.0f}".format(component.cost_low) }}
                                {% if component.cost_high %}
                                - ${{ "{:,.0f}".format(component.cost_high) }}
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Source Facts -->
                {% if cost.source_facts and cost.source_facts|length > 0 %}
                <div class="cost-section">
                    <div class="section-label">Based On Facts</div>
                    <div class="source-facts-chips">
                        {% for fact_id in cost.source_facts %}
                        <a href="{{ url_for('facts') }}?q={{ fact_id }}" class="fact-chip" target="_blank">{{ fact_id }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Confidence Level -->
                {% if cost.confidence %}
                <div class="cost-section">
                    <div class="section-label">Confidence Level</div>
                    <div class="confidence-display">
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: {{ (cost.confidence * 100)|int }}%"></div>
                        </div>
                        <span class="confidence-text">{{ (cost.confidence * 100)|int }}% Confident</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    <!-- END: Cost Breakdown Modal -->

</div>
{% endblock %}

{% block scripts %}
<style>
.risk-detail-container {
    max-width: 900px;
}

.risk-header {
    display: flex;
    gap: var(--space-4);
    align-items: flex-start;
    margin-bottom: var(--space-6);
    padding: var(--space-4);
    background: var(--bg-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-muted);
}

.risk-severity .badge-lg {
    font-size: 1rem;
    padding: var(--space-2) var(--space-4);
}

.risk-title-section h2 {
    margin: 0 0 var(--space-2) 0;
    font-size: 1.5rem;
}

.risk-meta {
    display: flex;
    gap: var(--space-3);
    color: var(--text-muted);
    font-size: 0.875rem;
}

.evidence-chain-card {
    border-color: var(--accent);
    border-width: 2px;
}

.evidence-chain-card .card-header {
    background: linear-gradient(135deg, var(--accent) 0%, #3b82f6 100%);
    color: white;
}

.evidence-chain-card .card-header h3 {
    color: white;
}

.evidence-chain-card .card-header .text-muted {
    color: rgba(255,255,255,0.8);
}

.section-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.reasoning-content {
    background: var(--bg-surface-sunken);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    line-height: 1.8;
}

.reasoning-arrow {
    color: var(--accent);
    font-weight: bold;
    padding: 0 var(--space-2);
}

.facts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.fact-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-muted);
    border-radius: var(--radius-md);
    padding: var(--space-4);
}

.fact-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--space-2);
}

.fact-id {
    background: var(--bg-surface-sunken);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
}

.fact-domain {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.fact-item {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: var(--space-3);
}

.fact-evidence {
    background: var(--bg-surface-sunken);
    padding: var(--space-3);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-3);
}

.evidence-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.evidence-quote {
    border-left: 3px solid var(--accent);
    padding-left: var(--space-3);
    margin: 0;
    font-style: italic;
    background: white;
    padding: var(--space-2) var(--space-3);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
}

.evidence-source {
    margin-top: var(--space-2);
    font-size: 0.875rem;
    color: var(--text-muted);
}

.fact-source-doc {
    margin-top: var(--space-2);
    font-size: 0.875rem;
}

.source-docs {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
    margin-top: var(--space-1);
}

.source-doc-chip {
    background: var(--bg-surface-sunken);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 300px;
}

.fact-details {
    margin-top: var(--space-3);
    border-top: 1px solid var(--border-muted);
    padding-top: var(--space-2);
}

.details-toggle {
    color: var(--accent);
    cursor: pointer;
    font-size: 0.875rem;
}

.details-toggle:hover {
    text-decoration: underline;
}

.details-content {
    display: none;
    margin-top: var(--space-2);
    padding: var(--space-2);
    background: var(--bg-surface-sunken);
    border-radius: var(--radius-sm);
}

.fact-details.expanded .details-content {
    display: block;
}

.fact-details.expanded .details-toggle::before {
    content: "Hide ";
}

.detail-row {
    display: flex;
    gap: var(--space-2);
    padding: var(--space-1) 0;
    font-size: 0.875rem;
}

.detail-key {
    color: var(--text-muted);
    min-width: 120px;
}

.work-items-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.work-items-list li {
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--border-muted);
    display: flex;
    gap: var(--space-2);
    align-items: center;
}

.work-items-list li:last-child {
    border-bottom: none;
}

.inline-form {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.note-form {
    display: flex;
    flex-direction: column;
}

.note-form label {
    margin-bottom: var(--space-1);
}

/* Affected Items Styles */
.affected-items-card {
    border-color: #f59e0b;
    border-width: 2px;
}

.affected-items-card .card-header {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    color: white;
}

.affected-items-card .card-header h3 {
    color: white;
}

.affected-items-card .card-header .text-muted {
    color: rgba(255,255,255,0.8);
}

.affected-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--space-3);
}

.affected-item {
    background: var(--bg-surface);
    border: 1px solid var(--border-muted);
    border-radius: var(--radius-md);
    padding: var(--space-3);
}

.affected-item-header {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.item-type-badge {
    font-size: 0.65rem;
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-weight: 600;
}

.item-type-badge.application {
    background: #dbeafe;
    color: #1e40af;
}

.item-type-badge.infrastructure {
    background: #dcfce7;
    color: #166534;
}

.affected-item-name {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: var(--space-1);
}

.affected-item-details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    font-size: 0.8rem;
    color: var(--text-muted);
}

.affected-item-details span {
    background: var(--bg-surface-sunken);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
}

.item-cost {
    color: var(--accent);
    font-weight: 500;
}

/* M&A Card Styles */
.mna-card {
    border-color: #6366f1;
    border-width: 2px;
}

.mna-card .card-header {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
}

.mna-card .card-header h3 {
    color: white;
}

.mna-lens {
    display: flex;
    gap: var(--space-2);
    align-items: center;
}

.lens-label {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.lens-value {
    background: #e0e7ff;
    color: #4338ca;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.875rem;
}

.implication-text {
    background: var(--bg-surface-sunken);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    border-left: 4px solid #6366f1;
    margin: 0;
}

.mna-timeline {
    display: flex;
    gap: var(--space-2);
    align-items: center;
    font-size: 0.9rem;
}

.timeline-icon {
    font-size: 1.1rem;
}

.timeline-value {
    font-weight: 600;
    color: var(--accent);
}

.mna-confidence {
    font-size: 0.875rem;
}

/* Cost Impact Summary */
.cost-impact-summary {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #fbbf24;
    border-radius: var(--radius-md);
    padding: var(--space-4);
}

.cost-impact-header {
    font-size: 0.75rem;
    font-weight: 600;
    color: #92400e;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-3);
}

.cost-impact-stats {
    display: flex;
    gap: var(--space-6);
    flex-wrap: wrap;
}

.impact-stat {
    text-align: center;
}

.impact-stat .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #92400e;
}

.impact-stat .stat-label {
    font-size: 0.75rem;
    color: #b45309;
    text-transform: uppercase;
}

/* ========================================
   MVP ENHANCEMENTS - Explanatory UI
   ======================================== */

/* Inline Context Display */
.inline-context {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
    padding: var(--space-3);
    margin-top: var(--space-3);
    background: #f6f8fa;
    border-left: 3px solid #0969da;
    border-radius: var(--radius-sm);
    font-size: 0.95rem;
    line-height: 1.6;
}

.inline-context .context-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
}

.inline-context .context-text {
    color: var(--text);
    font-weight: 500;
}

/* Inline Action Buttons */
.inline-actions {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-3);
}

.inline-actions .btn-link {
    padding: var(--space-1) var(--space-2);
    font-size: 0.875rem;
    color: var(--accent);
    text-decoration: none;
    background: none;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.inline-actions .btn-link:hover {
    text-decoration: underline;
    color: #0550ae;
}

/* Expandable Details Section */
.expanded-details-section {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

.modal-content {
    position: relative;
    max-width: 700px;
    max-height: 90vh;
    margin: 5vh auto;
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    background: linear-gradient(135deg, var(--accent) 0%, #3b82f6 100%);
    color: white;
}

.modal-header h3 {
    margin: 0;
    color: white;
    font-size: 1.25rem;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: background 0.2s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: var(--space-4);
    overflow-y: auto;
}

/* Cost Breakdown Styles */
.cost-total {
    text-align: center;
    padding: var(--space-4);
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
}

.cost-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-1);
}

.cost-value {
    font-size: 2rem;
    font-weight: 700;
    color: #0369a1;
}

.cost-section {
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--border-muted);
}

.cost-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.estimation-method-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-3);
    background: #dbeafe;
    color: #1e40af;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 600;
}

.cost-formula {
    padding: var(--space-3);
    background: var(--bg-surface-sunken);
    border-radius: var(--radius-sm);
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.95rem;
    color: var(--text);
    border-left: 3px solid var(--accent);
}

.assumptions-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.assumptions-list li {
    padding: var(--space-2);
    margin-bottom: var(--space-2);
    background: var(--bg-surface-sunken);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    padding-left: var(--space-4);
    position: relative;
}

.assumptions-list li::before {
    content: "‚Ä¢";
    position: absolute;
    left: var(--space-2);
    color: var(--accent);
    font-weight: bold;
}

.cost-components-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.cost-component {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) var(--space-3);
    background: var(--bg-surface);
    border: 1px solid var(--border-muted);
    border-radius: var(--radius-sm);
}

.component-label {
    font-weight: 500;
    color: var(--text);
}

.component-value {
    font-weight: 600;
    color: var(--accent);
}

.source-facts-chips {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
}

.fact-chip {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    background: var(--bg-surface-sunken);
    border: 1px solid var(--border-muted);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    font-family: 'Monaco', 'Courier New', monospace;
    color: var(--accent);
    text-decoration: none;
    transition: all 0.2s;
}

.fact-chip:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

.confidence-display {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.confidence-bar {
    flex: 1;
    height: 8px;
    background: var(--bg-surface-sunken);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    transition: width 0.3s ease;
}

.confidence-text {
    font-weight: 600;
    color: var(--text);
    font-size: 0.875rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .modal-content {
        max-width: 95%;
        margin: 2vh auto;
        max-height: 96vh;
    }

    .cost-value {
        font-size: 1.5rem;
    }

    .inline-actions {
        flex-direction: column;
        align-items: flex-start;
    }
}

</style>

<script>
// Toggle expandable details section
function toggleDetails() {
    const detailsSection = document.getElementById('expandedDetails');
    const btnText = document.getElementById('explainBtnText');

    if (detailsSection.style.display === 'none') {
        detailsSection.style.display = 'block';
        btnText.textContent = 'Hide Details ‚ñ≤';
    } else {
        detailsSection.style.display = 'none';
        btnText.textContent = 'Explain This ‚ñº';
    }
}

// Open cost breakdown modal
function openCostModal() {
    const modal = document.getElementById('costModal');
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent background scroll
    }
}

// Close cost breakdown modal
function closeCostModal() {
    const modal = document.getElementById('costModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scroll
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCostModal();
    }
});
</script>

{% endblock %}
