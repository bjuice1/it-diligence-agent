{% extends "base.html" %}

{% block title %}Facts - IT Due Diligence{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Facts</h1>
    <p>{{ total }} facts discovered during analysis</p>
</div>

<!-- Filters Bar -->
<form class="filters-bar" method="GET" action="{{ url_for('facts') }}" role="search">
    <div class="filter-group">
        <label class="filter-label" for="filter-domain">Domain</label>
        <select class="filter-select" id="filter-domain" name="domain" onchange="this.form.submit()">
            <option value="">All Domains</option>
            {% for domain in domains %}
            <option value="{{ domain }}" {{ 'selected' if domain_filter == domain }}>{{ domain|replace('_', ' ')|title }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group">
        <label class="filter-label" for="filter-category">Category</label>
        <select class="filter-select" id="filter-category" name="category" onchange="this.form.submit()">
            <option value="">All Categories</option>
            {% for category in categories %}
            <option value="{{ category }}" {{ 'selected' if category_filter == category }}>{{ category|replace('_', ' ')|title }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group">
        <label class="filter-label" for="filter-entity">Entity</label>
        <select class="filter-select" id="filter-entity" name="entity" onchange="this.form.submit()">
            <option value="">All Entities</option>
            <option value="target" {{ 'selected' if entity_filter == 'target' }}>Target</option>
            <option value="buyer" {{ 'selected' if entity_filter == 'buyer' }}>Buyer</option>
        </select>
    </div>

    <div class="filter-group filter-search">
        <label class="filter-label" for="filter-search">Search</label>
        <input type="search" class="filter-input" id="filter-search" name="q"
               placeholder="Search facts..." value="{{ request.args.get('q', '') }}"
               aria-label="Search facts">
    </div>

    <div class="filters-actions">
        {% if domain_filter or category_filter or entity_filter or request.args.get('q') %}
        <a href="{{ url_for('facts') }}" class="btn btn-ghost btn-sm">Clear Filters</a>
        {% endif %}
    </div>
</form>

<!-- Facts Table -->
<div class="table-container">
    <table class="table" aria-label="Facts table">
        <thead>
            <tr>
                <th scope="col" style="width: 120px;">ID</th>
                <th scope="col" style="width: 80px;">Entity</th>
                <th scope="col">Item</th>
                <th scope="col" style="width: 120px;">Category</th>
                <th scope="col" style="width: 100px;">Domain</th>
                <th scope="col" style="width: 100px;">Status</th>
            </tr>
        </thead>
        <tbody>
            {% if facts %}
            {% for fact in facts %}
            <tr data-id="{{ fact.fact_id }}"
                data-item="{{ fact.item|e }}"
                data-category="{{ fact.category }}"
                data-domain="{{ fact.domain }}"
                data-entity="{{ fact.entity|default('target') }}"
                data-status="{{ fact.status }}"
                data-details="{{ fact.details|tojson|e if fact.details else '{}' }}"
                data-evidence="{{ fact.evidence.exact_quote|e if fact.evidence and fact.evidence.exact_quote else '' }}"
                data-source="{{ fact.evidence.source_section|e if fact.evidence and fact.evidence.source_section else '' }}"
                data-source-doc="{{ fact.source_document|e if fact.source_document else '' }}"
                data-confidence="{{ fact.confidence_score|default(0) }}">
                <td class="font-mono text-sm">{{ fact.fact_id }}</td>
                <td>
                    {% if fact.entity == 'buyer' %}
                    <span class="badge badge-info">Buyer</span>
                    {% else %}
                    <span class="badge badge-outline badge-info">Target</span>
                    {% endif %}
                </td>
                <td>{{ fact.item }}</td>
                <td class="text-muted text-sm">{{ fact.category|replace('_', ' ')|title }}</td>
                <td class="text-muted text-sm">{{ fact.domain|replace('_', ' ')|title }}</td>
                <td>
                    {% if fact.status == 'gap' %}
                    <span class="badge badge-critical">Gap</span>
                    {% elif fact.status == 'partial' %}
                    <span class="badge badge-medium">Partial</span>
                    {% else %}
                    <span class="badge badge-low">Documented</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <div class="empty-state-icon">&#x1F4C4;</div>
                        <div class="empty-state-title">No facts found</div>
                        <div class="empty-state-text">
                            {% if domain_filter or category_filter %}
                            Try adjusting your filters to see more results.
                            {% else %}
                            No facts have been discovered yet.
                            {% endif %}
                        </div>
                    </div>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_pages and total_pages > 1 %}
<div class="pagination mt-4">
    <div class="pagination-info">
        Showing {{ (page - 1) * per_page + 1 }} - {{ [page * per_page, total]|min }} of {{ total }} facts
    </div>
    <div class="pagination-controls">
        {% if page > 1 %}
        <a href="{{ url_for('facts', page=page-1, domain=domain_filter, category=category_filter, entity=entity_filter, q=request.args.get('q', '')) }}"
           class="btn btn-sm btn-ghost">&laquo; Previous</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="btn btn-sm btn-primary">{{ p }}</span>
            {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
            <a href="{{ url_for('facts', page=p, domain=domain_filter, category=category_filter, entity=entity_filter, q=request.args.get('q', '')) }}"
               class="btn btn-sm btn-ghost">{{ p }}</a>
            {% elif p == page - 3 or p == page + 3 %}
            <span class="btn btn-sm btn-ghost">...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="{{ url_for('facts', page=page+1, domain=domain_filter, category=category_filter, entity=entity_filter, q=request.args.get('q', '')) }}"
           class="btn btn-sm btn-ghost">Next &raquo;</a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<style>
.evidence-chain {
    background: var(--bg-surface-sunken);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    margin-top: var(--space-3);
}
.evidence-box {
    background: white;
    border: 1px solid var(--border-muted);
    border-radius: var(--radius-sm);
    padding: var(--space-3);
    margin-bottom: var(--space-3);
}
.evidence-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: block;
    margin-bottom: var(--space-2);
}
.evidence-quote {
    border-left: 3px solid var(--accent);
    padding-left: var(--space-3);
    margin: 0;
    font-style: italic;
    color: var(--text);
    background: var(--bg-surface);
    padding: var(--space-2) var(--space-3);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
}
.evidence-source {
    margin-top: var(--space-2);
    font-size: 0.875rem;
}
.evidence-source .evidence-label {
    display: inline;
    margin-right: var(--space-2);
}
.evidence-confidence {
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px solid var(--border-muted);
}
.source-docs-list {
    margin-top: var(--space-2);
}
.source-doc-item {
    font-size: 0.8rem;
    padding: var(--space-1) var(--space-2);
    background: white;
    border: 1px solid var(--border-muted);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-1);
}
</style>
<script>
    // Handle row selection and open drawer
    document.addEventListener('rowSelected', function(e) {
        const row = e.detail.row;
        const data = row.dataset;
        let details = {};
        try {
            details = JSON.parse(data.details);
        } catch(e) {}

        // Format details as list
        let detailsHtml = '';
        for (const [key, value] of Object.entries(details)) {
            detailsHtml += `<div class="mb-2"><strong>${key}:</strong> ${value}</div>`;
        }
        if (!detailsHtml) detailsHtml = '<span class="text-muted">No additional details</span>';

        // Format confidence as percentage
        const confidence = parseFloat(data.confidence) || 0;
        const confidencePct = Math.round(confidence * 100);
        const confidenceClass = confidence >= 0.8 ? 'badge-low' : confidence >= 0.6 ? 'badge-medium' : 'badge-critical';

        // Format source document(s)
        let sourceDocsHtml = '<span class="text-muted">Unknown source</span>';
        if (data.sourceDoc) {
            const docs = data.sourceDoc.split(', ').filter(d => d.trim());
            sourceDocsHtml = docs.map(doc => {
                // Extract readable name from hash_filename format
                const readable = doc.replace(/^[a-f0-9]+_/, '').replace(/_/g, ' ').replace('.md', '');
                return `<div class="source-doc-item">${readable}</div>`;
            }).join('');
        }

        openDrawer(
            data.item,
            `
            <div class="drawer-section">
                <div class="drawer-section-title">Fact ID</div>
                <div class="drawer-section-content font-mono">${data.id}</div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Entity</div>
                <div class="drawer-section-content">
                    <span class="badge badge-${data.entity === 'buyer' ? 'info' : 'outline badge-info'}">${data.entity.toUpperCase()}</span>
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Domain / Category</div>
                <div class="drawer-section-content">${data.domain.replace('_', ' ')} / ${data.category.replace('_', ' ')}</div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Status</div>
                <div class="drawer-section-content">${data.status}</div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Details</div>
                <div class="drawer-section-content">${detailsHtml}</div>
            </div>
            <div class="drawer-section evidence-chain">
                <div class="drawer-section-title">Evidence Chain</div>
                <div class="drawer-section-content">
                    <div class="evidence-box">
                        <div class="evidence-label">Exact Quote from Document</div>
                        <blockquote class="evidence-quote">
                            ${data.evidence || 'No evidence quote available'}
                        </blockquote>
                    </div>
                    ${data.source ? `
                    <div class="evidence-source">
                        <span class="evidence-label">Section:</span> ${data.source}
                    </div>
                    ` : ''}
                    <div class="evidence-source">
                        <span class="evidence-label">Source Document(s):</span>
                        <div class="source-docs-list">${sourceDocsHtml}</div>
                    </div>
                    <div class="evidence-confidence">
                        <span class="evidence-label">Confidence:</span>
                        <span class="badge ${confidenceClass}">${confidencePct}%</span>
                    </div>
                </div>
            </div>
            `,
            `<button class="btn btn-secondary" onclick="closeDrawer()">Close</button>`
        );
    });
</script>
{% endblock %}
