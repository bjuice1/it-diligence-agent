{% extends "base.html" %}

{% block title %}Deals - IT Due Diligence{% endblock %}

{% block head %}
<style>
    .deals-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-6);
    }

    .deals-title {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        color: var(--text-primary);
    }

    .deals-actions {
        display: flex;
        gap: var(--space-3);
        align-items: center;
    }

    .search-input {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        width: 240px;
        background: var(--bg-surface);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    .filter-select {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        background: var(--bg-surface);
    }

    .btn-new-deal {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        background: var(--accent);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: background var(--transition-fast);
    }

    .btn-new-deal:hover {
        background: var(--accent-hover);
    }

    .deals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: var(--space-4);
    }

    .deal-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        transition: all var(--transition-fast);
        cursor: pointer;
        position: relative;
    }

    .deal-card:hover {
        border-color: var(--accent);
        box-shadow: var(--shadow-md);
    }

    .deal-card.active {
        border-color: var(--accent);
        background: var(--accent-subtle);
    }

    .deal-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-3);
    }

    .deal-name {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin-bottom: var(--space-1);
    }

    .deal-meta {
        display: flex;
        gap: var(--space-2);
        font-size: var(--text-xs);
        color: var(--text-tertiary);
    }

    .deal-type-badge {
        padding: var(--space-1) var(--space-2);
        background: var(--bg-surface-sunken);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
    }

    .deal-status {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
    }

    .deal-status.draft { background: var(--bg-surface-sunken); color: var(--text-secondary); }
    .deal-status.active { background: var(--accent-subtle); color: var(--accent); }
    .deal-status.analyzing { background: #fef3c7; color: #d97706; }
    .deal-status.complete { background: #d1fae5; color: #059669; }
    .deal-status.archived { background: #f3f4f6; color: #6b7280; }

    .deal-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-3);
        margin-top: var(--space-4);
        padding-top: var(--space-4);
        border-top: 1px solid var(--border-subtle);
    }

    .deal-stat {
        text-align: center;
    }

    .deal-stat-value {
        font-size: var(--text-xl);
        font-weight: var(--font-bold);
        color: var(--text-primary);
    }

    .deal-stat-label {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
    }

    .deal-progress {
        margin-top: var(--space-4);
    }

    .deal-progress-bar {
        height: 6px;
        background: var(--bg-surface-sunken);
        border-radius: 3px;
        overflow: hidden;
    }

    .deal-progress-fill {
        height: 100%;
        background: var(--accent);
        transition: width var(--transition-base);
    }

    .deal-progress-label {
        display: flex;
        justify-content: space-between;
        margin-top: var(--space-1);
        font-size: var(--text-xs);
        color: var(--text-tertiary);
    }

    .deal-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: var(--space-4);
        font-size: var(--text-xs);
        color: var(--text-tertiary);
    }

    .deal-actions-dropdown {
        position: relative;
    }

    .deal-actions-btn {
        padding: var(--space-1) var(--space-2);
        background: none;
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: var(--text-sm);
    }

    .deal-actions-menu {
        position: absolute;
        right: 0;
        top: 100%;
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        min-width: 160px;
        display: none;
        z-index: 10;
    }

    .deal-actions-menu.show {
        display: block;
    }

    .deal-action-item {
        display: block;
        width: 100%;
        padding: var(--space-2) var(--space-3);
        text-align: left;
        background: none;
        border: none;
        font-size: var(--text-sm);
        color: var(--text-primary);
        cursor: pointer;
    }

    .deal-action-item:hover {
        background: var(--bg-surface-sunken);
    }

    .deal-action-item.danger {
        color: var(--danger);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-12) var(--space-6);
        background: var(--bg-surface);
        border: 2px dashed var(--border-default);
        border-radius: var(--radius-lg);
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: var(--space-4);
    }

    .empty-state-title {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
        color: var(--text-primary);
        margin-bottom: var(--space-2);
    }

    .empty-state-text {
        color: var(--text-secondary);
        margin-bottom: var(--space-6);
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition-base);
    }

    .modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .modal {
        background: var(--bg-surface);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-5);
        border-bottom: 1px solid var(--border-default);
    }

    .modal-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: var(--text-xl);
        cursor: pointer;
        color: var(--text-secondary);
    }

    .modal-body {
        padding: var(--space-5);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
        padding: var(--space-5);
        border-top: 1px solid var(--border-default);
    }

    .form-group {
        margin-bottom: var(--space-4);
    }

    .form-label {
        display: block;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--text-primary);
        margin-bottom: var(--space-1);
    }

    .form-label.required::after {
        content: " *";
        color: var(--danger);
    }

    .form-input {
        width: 100%;
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        background: var(--bg-surface);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-4);
    }

    .btn-secondary {
        padding: var(--space-2) var(--space-4);
        background: var(--bg-surface);
        color: var(--text-primary);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
    }

    .btn-primary {
        padding: var(--space-2) var(--space-4);
        background: var(--accent);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
    }

    .btn-primary:hover {
        background: var(--accent-hover);
    }
</style>
{% endblock %}

{% block content %}
<div class="deals-header">
    <h1 class="deals-title">Your Deals</h1>
    <div class="deals-actions">
        <input type="text" class="search-input" id="dealSearch" placeholder="Search deals...">
        <select class="filter-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="active">Active</option>
            <option value="analyzing">Analyzing</option>
            <option value="complete">Complete</option>
            <option value="archived">Archived</option>
        </select>
        <button class="btn-new-deal" onclick="openNewDealModal()">
            <span>+</span> New Deal
        </button>
    </div>
</div>

<div class="deals-grid" id="dealsGrid">
    <!-- Deals loaded via JavaScript -->
</div>

<div class="empty-state" id="emptyState" style="display: none;">
    <div class="empty-state-icon">ðŸ“‹</div>
    <h2 class="empty-state-title">No deals yet</h2>
    <p class="empty-state-text">Create your first deal to get started with IT due diligence analysis.</p>
    <button class="btn-new-deal" onclick="openNewDealModal()">
        <span>+</span> Create Your First Deal
    </button>
</div>

<!-- New Deal Modal -->
<div class="modal-overlay" id="newDealModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Create New Deal</h2>
            <button class="modal-close" onclick="closeNewDealModal()">&times;</button>
        </div>
        <form id="newDealForm" onsubmit="createDeal(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">Deal Name</label>
                    <input type="text" class="form-input" name="name" required
                           placeholder="e.g., Acme Corp Acquisition">
                </div>
                <div class="form-group">
                    <label class="form-label required">Target Company</label>
                    <input type="text" class="form-input" name="target_name" required
                           placeholder="Company being analyzed">
                </div>
                <div class="form-group">
                    <label class="form-label">Buyer Company</label>
                    <input type="text" class="form-input" name="buyer_name"
                           placeholder="Acquiring company (optional)">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">Deal Type</label>
                        <select class="form-input" name="deal_type" id="modal-deal-type" required>
                            <option value="" disabled selected>-- Select Deal Type --</option>
                            <option value="acquisition">Acquisition (Integration)</option>
                            <option value="carveout">Carve-Out (Separation)</option>
                            <option value="divestiture">Divestiture (Clean Break)</option>
                        </select>
                        <small class="form-hint" id="modal-deal-type-help" style="display: block; margin-top: 4px; font-size: 11px;"></small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select class="form-input" name="industry">
                            <option value="">Select Industry</option>
                            <option value="technology">Technology</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="financial">Financial Services</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="retail">Retail</option>
                            <option value="energy">Energy</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNewDealModal()">Cancel</button>
                <button type="submit" class="btn-primary">Create Deal</button>
            </div>
        </form>
    </div>
</div>

<script>
    let deals = [];
    let currentDealId = null;

    // Load deals on page load
    document.addEventListener('DOMContentLoaded', loadDeals);

    // Dynamic help text for deal type in modal
    const modalDealTypeSelect = document.getElementById('modal-deal-type');
    const modalDealTypeHelp = document.getElementById('modal-deal-type-help');
    if (modalDealTypeSelect && modalDealTypeHelp) {
        const descriptions = {
            'acquisition': 'System will recommend consolidation synergies',
            'carveout': 'System will focus on separation costs and TSA exposure',
            'divestiture': 'System will calculate extraction costs'
        };

        modalDealTypeSelect.addEventListener('change', function() {
            const selectedValue = this.value;
            if (descriptions[selectedValue]) {
                modalDealTypeHelp.textContent = descriptions[selectedValue];
            }
        });
    }

    async function loadDeals() {
        try {
            const params = new URLSearchParams({
                include_archived: document.getElementById('statusFilter').value === 'archived'
            });

            const response = await fetch(`/api/deals?${params}`);
            const data = await response.json();
            deals = data.deals || [];

            // Get current deal
            const sessionRes = await fetch('/api/session/deal');
            const sessionData = await sessionRes.json();
            currentDealId = sessionData.deal?.id;

            renderDeals();
        } catch (error) {
            console.error('Error loading deals:', error);
        }
    }

    function renderDeals() {
        const grid = document.getElementById('dealsGrid');
        const emptyState = document.getElementById('emptyState');
        const search = document.getElementById('dealSearch').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;

        let filtered = deals.filter(deal => {
            const matchesSearch = !search ||
                deal.name.toLowerCase().includes(search) ||
                deal.target_name.toLowerCase().includes(search) ||
                (deal.buyer_name || '').toLowerCase().includes(search);

            const matchesStatus = !statusFilter || deal.status === statusFilter;

            return matchesSearch && matchesStatus;
        });

        if (filtered.length === 0) {
            grid.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        grid.innerHTML = filtered.map(deal => `
            <div class="deal-card ${deal.id === currentDealId ? 'active' : ''}"
                 onclick="selectDeal('${deal.id}')">
                <div class="deal-card-header">
                    <div>
                        <div class="deal-name">${escapeHtml(deal.name)}</div>
                        <div class="deal-meta">
                            <span class="deal-type-badge">${getDealTypeBadge(deal.deal_type)}</span>
                            ${deal.industry ? `<span>${deal.industry}</span>` : ''}
                        </div>
                    </div>
                    <span class="deal-status ${deal.status}">${deal.status}</span>
                </div>

                <div class="deal-stats">
                    <div class="deal-stat">
                        <div class="deal-stat-value">${deal.documents_uploaded || 0}</div>
                        <div class="deal-stat-label">Documents</div>
                    </div>
                    <div class="deal-stat">
                        <div class="deal-stat-value">${deal.facts_extracted || 0}</div>
                        <div class="deal-stat-label">Facts</div>
                    </div>
                    <div class="deal-stat">
                        <div class="deal-stat-value">${deal.findings_count || 0}</div>
                        <div class="deal-stat-label">Findings</div>
                    </div>
                </div>

                <div class="deal-progress">
                    <div class="deal-progress-bar">
                        <div class="deal-progress-fill" style="width: ${deal.review_percent || 0}%"></div>
                    </div>
                    <div class="deal-progress-label">
                        <span>Review Progress</span>
                        <span>${Math.round(deal.review_percent || 0)}%</span>
                    </div>
                </div>

                <div class="deal-card-footer">
                    <span>Updated ${formatDate(deal.updated_at)}</span>
                    <div class="deal-actions-dropdown">
                        <button class="deal-actions-btn" onclick="event.stopPropagation(); toggleDealMenu('${deal.id}')">â‹®</button>
                        <div class="deal-actions-menu" id="menu-${deal.id}">
                            <button class="deal-action-item" onclick="event.stopPropagation(); viewDeal('${deal.id}')">View Details</button>
                            <button class="deal-action-item" onclick="event.stopPropagation(); duplicateDeal('${deal.id}')">Duplicate</button>
                            <button class="deal-action-item" onclick="event.stopPropagation(); exportDeal('${deal.id}')">Export</button>
                            <button class="deal-action-item danger" onclick="event.stopPropagation(); archiveDeal('${deal.id}')">${deal.status === 'archived' ? 'Restore' : 'Archive'}</button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getDealTypeBadge(dealType) {
        const badges = {
            'acquisition': 'Acquisition',
            'carveout': 'Carve-Out',
            'divestiture': 'Divestiture'
        };
        return badges[dealType] || 'Acquisition';
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'Never';
        const date = new Date(dateStr);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

        return date.toLocaleDateString();
    }

    async function selectDeal(dealId) {
        try {
            await fetch('/api/session/deal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deal_id: dealId })
            });
            window.location.href = `/deals/${dealId}`;
        } catch (error) {
            console.error('Error selecting deal:', error);
        }
    }

    function viewDeal(dealId) {
        window.location.href = `/deals/${dealId}`;
    }

    function toggleDealMenu(dealId) {
        document.querySelectorAll('.deal-actions-menu').forEach(m => {
            if (m.id !== `menu-${dealId}`) m.classList.remove('show');
        });
        document.getElementById(`menu-${dealId}`).classList.toggle('show');
    }

    // Close menus when clicking outside
    document.addEventListener('click', () => {
        document.querySelectorAll('.deal-actions-menu').forEach(m => m.classList.remove('show'));
    });

    // Search and filter handlers
    document.getElementById('dealSearch').addEventListener('input', renderDeals);
    document.getElementById('statusFilter').addEventListener('change', loadDeals);

    // Modal functions
    function openNewDealModal() {
        document.getElementById('newDealModal').classList.add('show');
    }

    function closeNewDealModal() {
        document.getElementById('newDealModal').classList.remove('show');
        document.getElementById('newDealForm').reset();
    }

    async function createDeal(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Validate deal type is selected
        if (!data.deal_type || data.deal_type === '') {
            alert('Deal type is required. Please select Acquisition, Carve-Out, or Divestiture.');
            return;
        }

        // Confirmation for carve-out/divestiture
        if (data.deal_type === 'carveout' || data.deal_type === 'divestiture') {
            const confirmed = confirm(
                `You selected ${data.deal_type.toUpperCase()}.\n\n` +
                'This will analyze the deal as a SEPARATION (not integration).\n' +
                'System will calculate standalone build-out costs.\n\n' +
                'Is this correct?'
            );

            if (!confirmed) {
                return;
            }
        }

        try {
            const response = await fetch('/api/deals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok) {
                alert(result.error || 'Failed to create deal');
                return;
            }

            closeNewDealModal();
            window.location.href = `/deals/${result.deal.id}`;
        } catch (error) {
            console.error('Error creating deal:', error);
            alert('Failed to create deal');
        }
    }

    async function duplicateDeal(dealId) {
        const newName = prompt('Enter name for the duplicated deal:');
        if (!newName) return;

        try {
            const response = await fetch(`/api/deals/${dealId}/duplicate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_name: newName })
            });

            if (response.ok) {
                loadDeals();
            } else {
                const data = await response.json();
                alert(data.error || 'Failed to duplicate deal');
            }
        } catch (error) {
            console.error('Error duplicating deal:', error);
        }
    }

    async function exportDeal(dealId) {
        try {
            const response = await fetch(`/api/deals/${dealId}/export`);
            const data = await response.json();

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deal-export-${dealId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error('Error exporting deal:', error);
        }
    }

    async function archiveDeal(dealId) {
        const deal = deals.find(d => d.id === dealId);
        const action = deal?.status === 'archived' ? 'restore' : 'archive';

        if (!confirm(`Are you sure you want to ${action} this deal?`)) return;

        try {
            const response = await fetch(`/api/deals/${dealId}/${action}`, {
                method: 'POST'
            });

            if (response.ok) {
                loadDeals();
            } else {
                const data = await response.json();
                alert(data.error || `Failed to ${action} deal`);
            }
        } catch (error) {
            console.error(`Error ${action}ing deal:`, error);
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'n' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            openNewDealModal();
        }
        if (e.key === '/' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            document.getElementById('dealSearch').focus();
        }
        if (e.key === 'Escape') {
            closeNewDealModal();
        }
    });
</script>
{% endblock %}
