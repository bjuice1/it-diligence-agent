{% extends "base.html" %}

{% block title %}Risks - IT Due Diligence{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Risks</h1>
    <p>{{ risks|length }} risks identified across all domains</p>
</div>

<!-- Filters Bar -->
<form class="filters-bar" method="GET" action="{{ url_for('risks') }}" role="search">
    <div class="filter-group">
        <label class="filter-label" for="filter-domain">Domain</label>
        <select class="filter-select" id="filter-domain" name="domain" onchange="this.form.submit()">
            <option value="">All Domains</option>
            {% for domain in domains %}
            <option value="{{ domain }}" {{ 'selected' if domain_filter == domain }}>{{ domain|replace('_', ' ')|title }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group">
        <label class="filter-label" for="filter-severity">Severity</label>
        <select class="filter-select" id="filter-severity" name="severity" onchange="this.form.submit()">
            <option value="">All Severities</option>
            <option value="critical" {{ 'selected' if severity_filter == 'critical' }}>Critical</option>
            <option value="high" {{ 'selected' if severity_filter == 'high' }}>High</option>
            <option value="medium" {{ 'selected' if severity_filter == 'medium' }}>Medium</option>
            <option value="low" {{ 'selected' if severity_filter == 'low' }}>Low</option>
        </select>
    </div>

    <div class="filter-group filter-search">
        <label class="filter-label" for="filter-search">Search</label>
        <input type="search" class="filter-input" id="filter-search" name="q"
               placeholder="Search risks..." value="{{ request.args.get('q', '') }}"
               aria-label="Search risks">
    </div>

    <div class="filters-actions">
        {% if domain_filter or severity_filter or request.args.get('q') %}
        <a href="{{ url_for('risks') }}" class="btn btn-ghost btn-sm">Clear Filters</a>
        {% endif %}
        <button type="submit" class="btn btn-secondary btn-sm">Apply</button>
    </div>
</form>

<!-- Risks Table -->
<div class="table-container">
    <table class="table" aria-label="Risks table">
        <thead>
            <tr>
                <th scope="col" style="width: 100px;">Severity</th>
                <th scope="col" style="width: 80px;">ID</th>
                <th scope="col">Title</th>
                <th scope="col" style="width: 120px;">Domain</th>
                <th scope="col" style="width: 140px;">Based On</th>
            </tr>
        </thead>
        <tbody>
            {% if risks %}
            {% for risk in risks %}
            <tr data-id="{{ risk.finding_id }}"
                data-display-id="R-{{ '%03d'|format(loop.index) }}"
                data-severity="{{ risk.severity }}"
                data-domain="{{ risk.domain }}"
                data-title="{{ risk.title|e }}"
                data-description="{{ risk.description|e if risk.description else '' }}"
                data-mitigation="{{ risk.mitigation|e if risk.mitigation else '' }}"
                data-reasoning="{{ risk.reasoning|e if risk.reasoning else '' }}"
                data-based-on="{{ risk.based_on_facts|join(', ') if risk.based_on_facts else '' }}">
                <td>
                    <span class="badge badge-{{ risk.severity }}">{{ risk.severity|upper }}</span>
                </td>
                <td class="font-mono text-sm" title="{{ risk.finding_id }}">R-{{ '%03d'|format(loop.index) }}</td>
                <td>
                    <a href="{{ url_for('risk_detail', risk_id=risk.finding_id) }}" class="risk-title-link">
                        {{ risk.title }}
                    </a>
                    {% if risk.reasoning %}
                    <div class="risk-inline-hint">
                        <span class="hint-icon">ðŸ’¡</span>
                        <span class="hint-text">{{ (risk.reasoning.split('.')[0] + '.') if '.' in risk.reasoning else (risk.reasoning[:60] + '...' if risk.reasoning|length > 60 else risk.reasoning) }}</span>
                    </div>
                    {% endif %}
                </td>
                <td class="text-muted text-sm">{{ risk.domain|replace('_', ' ')|title }}</td>
                <td class="text-sm">
                    {% if risk.based_on_facts %}
                    <span class="fact-ids" title="{{ risk.based_on_facts|join(', ') }}">
                        {% for fact_id in risk.based_on_facts[:2] %}
                        <a href="{{ url_for('facts') }}?q={{ fact_id }}" class="fact-link">{{ fact_id }}</a>{% if not loop.last %} {% endif %}
                        {% endfor %}
                        {% if risk.based_on_facts|length > 2 %}
                        <span class="text-muted">+{{ risk.based_on_facts|length - 2 }}</span>
                        {% endif %}
                    </span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="5">
                    <div class="empty-state">
                        <div class="empty-state-icon">&#x1F50D;</div>
                        <div class="empty-state-title">No risks found</div>
                        <div class="empty-state-text">
                            {% if domain_filter or severity_filter %}
                            Try adjusting your filters to see more results.
                            {% else %}
                            No risks have been identified in this analysis.
                            {% endif %}
                        </div>
                    </div>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination mt-4">
    <div class="pagination-info">
        Showing {{ (page - 1) * per_page + 1 }} - {{ [page * per_page, total]|min }} of {{ total }} risks
    </div>
    <div class="pagination-controls">
        {% if page > 1 %}
        <a href="{{ url_for('risks', page=page-1, severity=severity_filter, domain=domain_filter, q=request.args.get('q', '')) }}"
           class="btn btn-sm btn-ghost">&laquo; Previous</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="btn btn-sm btn-primary">{{ p }}</span>
            {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
            <a href="{{ url_for('risks', page=p, severity=severity_filter, domain=domain_filter, q=request.args.get('q', '')) }}"
               class="btn btn-sm btn-ghost">{{ p }}</a>
            {% elif p == page - 3 or p == page + 3 %}
            <span class="btn btn-sm btn-ghost">...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="{{ url_for('risks', page=page+1, severity=severity_filter, domain=domain_filter, q=request.args.get('q', '')) }}"
           class="btn btn-sm btn-ghost">Next &raquo;</a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Summary Stats -->
{% if all_risks %}
<div class="flex gap-4 mt-4 text-sm text-muted">
    <span><strong>{{ all_risks|selectattr('severity', 'equalto', 'critical')|list|length }}</strong> Critical</span>
    <span><strong>{{ all_risks|selectattr('severity', 'equalto', 'high')|list|length }}</strong> High</span>
    <span><strong>{{ all_risks|selectattr('severity', 'equalto', 'medium')|list|length }}</strong> Medium</span>
    <span><strong>{{ all_risks|selectattr('severity', 'equalto', 'low')|list|length }}</strong> Low</span>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Format fact IDs as clickable links
    function formatFactLinks(factIds) {
        if (!factIds) return '<span class="text-muted">None</span>';
        const facts = factIds.split(', ').filter(f => f.trim());
        if (facts.length === 0) return '<span class="text-muted">None</span>';
        return facts.map(f =>
            `<a href="{{ url_for('facts') }}?q=${encodeURIComponent(f)}" class="fact-link">${f}</a>`
        ).join(' ');
    }

    // Handle row selection and open drawer
    document.addEventListener('rowSelected', function(e) {
        const row = e.detail.row;
        const data = row.dataset;

        // Format reasoning with arrow chain highlighting
        let reasoningHtml = data.reasoning || 'No reasoning provided';
        let hasReasoning = data.reasoning && data.reasoning !== 'No reasoning provided';
        if (hasReasoning) {
            // Highlight the reasoning chain arrows
            reasoningHtml = reasoningHtml.replace(/â†’/g, '<span class="reasoning-arrow">â†’</span>');
        }

        // Extract first sentence for inline context (MVP feature)
        let inlineReasoning = '';
        if (hasReasoning) {
            const firstSentence = data.reasoning.split('.')[0];
            inlineReasoning = `
                <div class="inline-context" style="display: flex; align-items: flex-start; gap: 8px; padding: 12px; margin: 12px 0; background: #f6f8fa; border-left: 3px solid #0969da; border-radius: 4px;">
                    <span style="font-size: 1.2rem; flex-shrink: 0;">ðŸ’¡</span>
                    <span style="color: #24292f; font-weight: 500; line-height: 1.6;">${firstSentence}.</span>
                </div>
            `;
        }

        // Check if has expandable content (MVP feature)
        const hasMitigation = data.mitigation && data.mitigation !== 'No mitigation specified';
        const hasExpandable = hasReasoning || hasMitigation;

        openDrawer(
            data.title,
            `
            <div class="drawer-section">
                <div class="drawer-section-title">ID</div>
                <div class="drawer-section-content font-mono">${data.displayId} <span class="text-muted text-sm">(${data.id})</span></div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Severity</div>
                <div class="drawer-section-content">
                    <span class="badge badge-${data.severity}">${data.severity.toUpperCase()}</span>
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Domain</div>
                <div class="drawer-section-content">${data.domain.replace('_', ' ')}</div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Description</div>
                <div class="drawer-section-content">
                    ${data.description || 'No description available'}
                    ${inlineReasoning}
                    ${hasExpandable ? `
                        <div style="margin-top: 12px;">
                            <button class="btn btn-link btn-sm" onclick="toggleDrawerDetails()" id="explainDrawerBtn" style="padding: 4px 8px; font-size: 0.875rem; color: #0969da; background: none; border: none; cursor: pointer;">
                                <span id="explainDrawerBtnText">Explain This â–¼</span>
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
            <div id="drawerExpandedDetails" style="display: none;">
                ${hasMitigation ? `
                <div class="drawer-section">
                    <div class="drawer-section-title">Mitigation</div>
                    <div class="drawer-section-content">${data.mitigation}</div>
                </div>
                ` : ''}
                <div class="drawer-section evidence-chain-section">
                    <div class="drawer-section-title">Why This Conclusion? (Evidence Chain)</div>
                    <div class="drawer-section-content">
                        <div class="reasoning-chain">${reasoningHtml}</div>
                        <div class="supporting-facts">
                            <div class="supporting-facts-label">Supporting Facts (click to see source evidence):</div>
                            <div class="font-mono text-sm">${formatFactLinks(data.basedOn)}</div>
                        </div>
                    </div>
                </div>
            </div>
            `,
            `
            <a href="{{ url_for('risk_detail', risk_id='') }}${data.id}" class="btn btn-primary">View Full Details</a>
            <button class="btn btn-secondary" onclick="closeDrawer()">Close</button>
            `
        );
    });

    // Toggle drawer expanded details (MVP feature)
    window.toggleDrawerDetails = function() {
        const detailsSection = document.getElementById('drawerExpandedDetails');
        const btnText = document.getElementById('explainDrawerBtnText');
        if (detailsSection && btnText) {
            if (detailsSection.style.display === 'none') {
                detailsSection.style.display = 'block';
                btnText.textContent = 'Hide Details â–²';
            } else {
                detailsSection.style.display = 'none';
                btnText.textContent = 'Explain This â–¼';
            }
        }
    };

    // Live search filtering
    const searchInput = document.getElementById('filter-search');
    if (searchInput) {
        let debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = this.value.toLowerCase();
                document.querySelectorAll('.table tbody tr[data-id]').forEach(row => {
                    const title = row.dataset.title.toLowerCase();
                    const description = row.dataset.description.toLowerCase();
                    const matches = title.includes(query) || description.includes(query);
                    row.style.display = matches ? '' : 'none';
                });
            }, 200);
        });
    }
</script>
<style>
.fact-link {
    color: var(--accent);
    text-decoration: none;
    padding: 2px 6px;
    background: var(--bg-surface-sunken);
    border-radius: 4px;
    font-size: 0.85em;
    display: inline-block;
    margin: 1px;
}
.fact-link:hover {
    background: var(--accent);
    color: white;
}
.fact-ids {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
}
.evidence-chain-section {
    background: var(--bg-surface-sunken);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    margin-top: var(--space-3);
}
.reasoning-chain {
    background: white;
    border: 1px solid var(--border-muted);
    border-radius: var(--radius-sm);
    padding: var(--space-3);
    line-height: 1.8;
    margin-bottom: var(--space-3);
}
.reasoning-arrow {
    color: var(--accent);
    font-weight: bold;
    padding: 0 var(--space-1);
}
.supporting-facts {
    padding-top: var(--space-3);
    border-top: 1px solid var(--border-muted);
}
.supporting-facts-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

/* ========================================
   MVP ENHANCEMENTS - List View
   ======================================== */
.risk-title-link {
    color: var(--text);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
}

.risk-title-link:hover {
    color: var(--accent);
    text-decoration: underline;
}

.risk-inline-hint {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    margin-top: 6px;
    padding: 6px 8px;
    background: #f6f8fa;
    border-left: 2px solid #0969da;
    border-radius: 3px;
    font-size: 0.85rem;
    line-height: 1.4;
    color: var(--text-muted);
}

.risk-inline-hint .hint-icon {
    font-size: 0.9rem;
    flex-shrink: 0;
}

.risk-inline-hint .hint-text {
    flex: 1;
}
</style>
{% endblock %}
